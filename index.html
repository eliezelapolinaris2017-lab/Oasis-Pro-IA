<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>OASIS PRO IA ‚Äì Suite</title>
<style>
:root{
  --bg:#0b1620;--card:#122635;--text:#e9f0f5;--muted:#9fb3c3;--line:#263948;--brand:#1ea672;
  --shadow:0 6px 20px rgba(0,0,0,.35);--radius:16px;--tap:48px;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{margin:0;color:var(--text);background:radial-gradient(1200px 600px at 10% -10%, #123149 0%, var(--bg) 45%, #081118 100%);font-family:ui-sans-serif,system-ui,-apple-system,"SF Pro Text",Segoe UI,Roboto,Arial}
body{padding-bottom:env(safe-area-inset-bottom)}
header{position:sticky;top:0;z-index:10;padding:14px max(16px,env(safe-area-inset-left)) 14px max(16px,env(safe-area-inset-right));background:linear-gradient(180deg,rgba(10,22,32,.95),rgba(10,22,32,.78));backdrop-filter:blur(10px);display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--line)}
header img.logo{height:28px;width:auto;object-fit:contain}
header h1{font-size:17px;margin:0;color:#a7d4ff}
.wrap{max-width:1000px;margin:0 auto;padding:16px}
.menu{display:grid;gap:12px}
.menu .item{border:1px solid var(--line);border-radius:18px;padding:14px 16px;background:linear-gradient(180deg,#12293a,#0f2230);box-shadow:var(--shadow);display:flex;justify-content:space-between;align-items:center}
.menu .item span{font-size:16px}
.menu .item small{color:var(--muted)}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
.card .hd{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)}
.card .hd h3{margin:0;font-size:16px}
.card .bd{padding:14px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.right{margin-left:auto}
.btn{display:inline-flex;align-items:center;justify-content:center;min-height:var(--tap);padding:10px 16px;border-radius:14px;border:1px solid #234257;background:linear-gradient(180deg,#142a3a,#0e1f2b);color:var(--text);font-size:15px;cursor:pointer;user-select:none;touch-action:manipulation;transition:.15s}
.btn.small{min-height:40px;font-size:14px;padding:8px 12px;border-radius:12px}
.btn.brand{border-color:#0d3e31;background:linear-gradient(180deg,#0f3c2d,#0c2d23)}
.btn.warn{border-color:#4b3612;background:linear-gradient(180deg,#3a2a0e,#2a1f0a);color:#ffd59b}
.btn.danger{border-color:#4b1717;background:linear-gradient(180deg,#341214,#240d0e);color:#ffc6c6}
.pill{display:inline-block;background:#172534;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
input,select,textarea{width:100%;padding:12px 14px;font-size:16px;border-radius:12px;color:var(--text);background:#0e2130;border:1px solid #22394a;outline:none;-webkit-appearance:none}
textarea{min-height:96px;resize:vertical}
label{font-size:12px;color:var(--muted)}
table{width:100%;border-collapse:collapse}
th,td{padding:10px 8px;border-bottom:1px solid var(--line);font-size:14px}
th{color:#a0bfd6;font-weight:600}
.hide{display:none!important}
footer{padding:20px 16px calc(20px + env(safe-area-inset-bottom));text-align:center;border-top:1px solid var(--line);color:#7fa0b4}

/* Impresi√≥n / PDF */
@media print{header,.no-print,footer{display:none!important}body{background:#fff;-webkit-print-color-adjust:exact;print-color-adjust:exact}.print-sheet{display:block}}
@page{size:auto;margin:12mm}
.print-sheet{display:none;background:#fff;color:#1a1a1a;padding:28px 28px 40px;font-family:ui-serif,Georgia,'Times New Roman',serif}
.p-head{display:flex;align-items:center;justify-content:space-between}
.p-head .brand{display:flex;align-items:center;gap:14px}
.p-head .brand img{height:58px}
.p-head .biz{font-size:12px;color:#333;line-height:1.45}
.p-sub{color:#555;font-size:12px;text-align:right}
.p-line{height:2px;background:linear-gradient(90deg,#0d2230,#4a6d86,#0d2230);opacity:.25;margin:10px 0 18px;border-radius:2px}
.p-table{width:100%;border-collapse:collapse;font-size:12.5px}
.p-table th,.p-table td{border-bottom:1px solid #e6ebef;padding:8px 6px}
.p-total td{border-top:1px solid #d7dde2}
.p-notes{margin-top:12px;font-size:12.5px}
.p-footer{margin-top:18px;padding-top:12px;border-top:1px dashed #cdd7df;font-size:11.5px;color:#444;display:flex;justify-content:space-between;gap:12px}
.p-sign{margin-top:20px;display:flex;align-items:center;gap:18px}
.p-sign img{height:46px}
.stamp{position:absolute;top:80px;right:40px;transform:rotate(-12deg);color:#c41;border:3px solid #c41;padding:6px 14px;font-weight:900;font-size:26px;opacity:.25}
</style>
</head>
<body>
<header>
  <img id="oasisLogoHeader" class="logo" alt="Oasis Pro IA" src="data:image/svg+xml;utf8,<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' width='220' height='60'><text x='0' y='40' font-family='Arial' font-size='32' fill='%23a7d4ff'>OASIS PRO IA</text></svg>">
  <h1>¬øQu√© deseas hacer?</h1>
  <span class="pill right no-print">Dashboard</span>
</header>

<div class="wrap">
  <!-- Men√∫ -->
  <div id="mainMenu" class="menu no-print">
    <div class="item" onclick="show('diag')"><span>üß∞ Diagn√≥stico</span><small>Buscar c√≥digos</small></div>
    <div class="item" onclick="show('agenda')"><span>üóìÔ∏è Agenda</span><small>Citas locales + Google</small></div>
    <div class="item" onclick="show('quotes')"><span>üìÑ Cotizaciones</span><small>Logo, pie, PDF</small></div>
    <div class="item" onclick="show('invoices')"><span>üßæ Facturas</span><small>Logo, pie, PDF</small></div>
    <div class="item" onclick="show('analytics')"><span>üìä Rendimientos</span><small>Estad√≠sticas</small></div>
    <div class="item" onclick="show('settings')"><span>‚öôÔ∏è Configuraci√≥n</span><small>Logo, contactos, c√≥digos</small></div>
    <div class="item" onclick="window.open('https://eliezelapolinaris2017-lab.github.io/Nexus-Tools-PR/codes/','_blank')"><span>üîé Buscar C√≥digos de Error</span><small>Enlace externo</small></div>
  </div>

  <!-- DIAGN√ìSTICO -->
  <section id="diag" class="card hide">
    <div class="hd"><h3>üß∞ Diagn√≥stico</h3><div class="row"><span class="pill">Base local</span><button class="btn small" onclick="show('mainMenu')">Volver</button></div></div>
    <div class="bd">
      <div class="row">
        <div style="flex:2"><label>B√∫squeda (marca, c√≥digo o palabra)</label><input id="diagQuery" placeholder="Ej: Midea E1 o 'sensor'"></div>
        <button class="btn small brand" onclick="searchCodes()">Buscar</button>
        <button class="btn small" onclick="listAllCodes()">Ver todos</button>
      </div>
      <div id="diagResults" style="margin-top:10px"></div>
    </div>
  </section>

  <!-- AGENDA -->
  <section id="agenda" class="card hide">
    <div class="hd"><h3>üóìÔ∏è Agenda</h3><div class="row"><button class="btn small brand" onclick="openAddEvent()">Nueva cita</button><button class="btn small" onclick="show('mainMenu')">Volver</button></div></div>
    <div class="bd">
      <div class="toolbar row">
        <input id="agendaFilter" placeholder="Filtrar por cliente/servicio/fecha (aaaa-mm-dd)">
        <button class="btn small" onclick="renderEvents()">Aplicar</button>
        <span class="pill right" id="agendaCount">0 citas</span>
      </div>
      <div id="agendaTable"></div>
    </div>
  </section>

  <!-- COTIZACIONES -->
  <section id="quotes" class="card hide">
    <div class="hd"><h3>üìÑ Cotizaciones</h3><div class="row"><button class="btn small brand" onclick="openDocForm('quote')">Nueva</button><button class="btn small" onclick="show('mainMenu')">Volver</button></div></div>
    <div class="bd"><div id="quotesTable"></div></div>
  </section>

  <!-- FACTURAS -->
  <section id="invoices" class="card hide">
    <div class="hd"><h3>üßæ Facturas</h3><div class="row"><button class="btn small brand" onclick="openDocForm('invoice')">Nueva</button><button class="btn small" onclick="show('mainMenu')">Volver</button></div></div>
    <div class="bd"><div id="invoicesTable"></div></div>
  </section>

  <!-- RENDIMIENTOS -->
  <section id="analytics" class="card hide">
    <div class="hd"><h3>üìä Rendimientos</h3><div class="row"><button class="btn small" onclick="recomputeAnalytics()">Actualizar</button><button class="btn small" onclick="show('mainMenu')">Volver</button></div></div>
    <div class="bd">
      <div id="analyticsSummary" class="row"></div>
      <div style="margin-top:10px"><canvas id="chart1" width="480" height="260" style="width:100%;height:260px;background:#0f1f2b;border:1px solid var(--line);border-radius:12px"></canvas></div>
    </div>
  </section>

  <!-- CONFIGURACI√ìN -->
  <section id="settings" class="card hide">
    <div class="hd"><h3>‚öôÔ∏è Configuraci√≥n</h3><div class="row"><button class="btn small" onclick="show('mainMenu')">Volver</button></div></div>
    <div class="bd">
      <h4>Identidad de negocio (global)</h4>
      <div class="row">
        <div style="flex:1 1 220px">
          <label>Logo global</label>
          <input type="file" accept="image/*" id="logoInput" onchange="handleLogo(event)">
          <div class="row" style="margin-top:8px"><img id="logoPreview" style="max-width:190px;max-height:90px" alt=""></div>
        </div>
        <div style="flex:2 1 320px">
          <label>Nombre</label><input id="bizName" placeholder="Oasis Air Cleaner Services LLC">
          <label>Tel√©fono</label><input id="bizPhone" placeholder="(787) 664-3079">
          <label>Sitio web</label><input id="bizWeb" placeholder="www.oasisservicespr.com">
          <label>Direcci√≥n</label><input id="bizAddr" placeholder="Trujillo Alto, Puerto Rico 00976">
          <div class="row" style="margin-top:8px"><button class="btn brand small" onclick="saveBiz()">Guardar</button></div>
        </div>
      </div>

      <h4 style="margin-top:18px">Contactos</h4>
      <div class="row">
        <div style="flex:1 1 240px">
          <label>Importar CSV/JSON</label>
          <input type="file" accept=".csv,.json" id="contactsFile" onchange="importContacts(event)">
          <div class="pill" style="margin-top:8px">CSV: nombre,telefono,email,direccion</div>
        </div>
        <div style="flex:2 1 360px">
          <div class="row">
            <input id="cName" placeholder="Nombre">
            <input id="cPhone" placeholder="Tel√©fono">
          </div>
          <div class="row" style="margin-top:8px">
            <input id="cEmail" placeholder="Email">
            <input id="cAddr" placeholder="Direcci√≥n">
          </div>
          <div class="row" style="margin-top:8px"><button class="btn brand small" onclick="addContact()">A√±adir</button></div>
        </div>
      </div>
      <div id="contactsTable" style="margin-top:8px"></div>

      <h4 style="margin-top:18px">C√≥digos de error</h4>
      <div class="row">
        <div style="flex:1 1 240px">
          <label>Importar CSV/JSON</label>
          <input type="file" accept=".csv,.json" id="codesFile" onchange="importCodes(event)">
          <div class="pill" style="margin-top:8px">Campos: marca,codigo,descripcion,solucion,tipo_falla,nivel,nota</div>
        </div>
        <div style="flex:2 1 360px">
          <div class="row">
            <input id="mBrand" placeholder="Marca">
            <input id="mCode" placeholder="C√≥digo">
          </div>
          <textarea id="mDesc" placeholder="Descripci√≥n"></textarea>
          <textarea id="mFix" placeholder="Soluci√≥n"></textarea>
          <div class="row">
            <input id="mType" placeholder="Tipo de falla">
            <input id="mLevel" placeholder="Nivel">
            <input id="mNote" placeholder="Nota">
          </div>
          <div class="row" style="margin-top:8px"><button class="btn brand small" onclick="addCode()">A√±adir c√≥digo</button></div>
        </div>
      </div>
      <div id="codesCount" class="pill" style="margin-top:8px">0 c√≥digos</div>
    </div>
  </section>

  <!-- MODAL -->
  <div id="modal" class="card hide no-print" style="position:fixed;inset:auto 10px 10px 10px;max-width:980px;margin:auto;background:#0e1f2b;z-index:20;max-height:85vh;overflow:auto;-webkit-overflow-scrolling:touch">
    <div class="hd"><h3 id="modalTitle">Documento</h3><button class="btn small" onclick="closeModal()">‚úï</button></div>
    <div id="modalBody" class="bd"></div>
  </div>

  <!-- VISTA PDF -->
  <div id="printView" class="print-sheet"></div>

  <footer class="no-print">Todos los derechos reservados ¬© <b>Nexus Tools PR</b></footer>
</div>

<script>
/* Utils */
const $=s=>document.querySelector(s), $$=s=>[...document.querySelectorAll(s)];
const LS={get:(k,d)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch(e){return d}},set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))};
const uid=(p='id')=>p+'_'+Math.random().toString(36).slice(2,9);
const money=n=>(+n||0).toLocaleString('es-PR',{style:'currency',currency:'USD'});
const esc=s=>(s??'').toString().replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));

/* Estado inicial */
const DEF_BIZ={name:"Oasis Air Cleaner Services LLC",phone:"(787) 664-3079",web:"www.oasisservicespr.com",addr:"Trujillo Alto, Puerto Rico 00976",logo:null};
if(!LS.get('biz')) LS.set('biz',DEF_BIZ);
['contacts','codes','events','quotes','invoices'].forEach(k=>{if(!LS.get(k)) LS.set(k,[])});
(function init(){
  const b=LS.get('biz'); if(b.logo) $('#oasisLogoHeader').src=b.logo;
  loadBiz(); renderContacts(); updateCounts();
  renderDocs('quote'); renderDocs('invoice'); renderEvents(); recomputeAnalytics();
})();

/* Navegaci√≥n */
function show(id){ $$('#mainMenu,#diag,#agenda,#quotes,#invoices,#analytics,#settings').forEach(e=>e.classList.add('hide')); $('#'+id).classList.remove('hide'); window.scrollTo({top:0,behavior:'smooth'}); }

/* Configuraci√≥n global */
function handleLogo(e){const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=x=>{const b=LS.get('biz'); b.logo=x.target.result; LS.set('biz',b); $('#logoPreview').src=b.logo; $('#oasisLogoHeader').src=b.logo;}; r.readAsDataURL(f);}
function saveBiz(){const b=LS.get('biz'); b.name=$('#bizName').value; b.phone=$('#bizPhone').value; b.web=$('#bizWeb').value; b.addr=$('#bizAddr').value; LS.set('biz',b); alert('Datos guardados');}
function loadBiz(){const b=LS.get('biz'); $('#bizName').value=b.name; $('#bizPhone').value=b.phone; $('#bizWeb').value=b.web; $('#bizAddr').value=b.addr; if(b.logo) $('#logoPreview').src=b.logo;}
function escHtml(s){return esc(s)}

/* Diagn√≥stico */
function searchCodes(){ const q=($('#diagQuery').value||'').toLowerCase(); const list=LS.get('codes',[]).filter(x=>[x.marca,x.codigo,x.descripcion,x.solucion,x.tipo_falla,x.nota].join(' ').toLowerCase().includes(q)); renderDiag(list,q); }
function listAllCodes(){ renderDiag(LS.get('codes',[]),'') }
function renderDiag(arr,q){ const el=$('#diagResults'); if(!arr.length){ el.innerHTML=`<div class="pill">Sin resultados ${q?`para "<b>${esc(q)}</b>"`:''}. Carga c√≥digos en Configuraci√≥n.</div>`; return; }
  let h=`<table><thead><tr><th>Marca</th><th>C√≥digo</th><th>Descripci√≥n</th><th>Soluci√≥n</th><th>Tipo</th><th>Nivel</th><th>Nota</th></tr></thead><tbody>`;
  arr.forEach(r=>h+=`<tr><td>${esc(r.marca)}</td><td><b>${esc(r.codigo)}</b></td><td>${esc(r.descripcion)}</td><td>${esc(r.solucion)}</td><td>${esc(r.tipo_falla||'')}</td><td>${esc(r.nivel||'')}</td><td>${esc(r.nota||'')}</td></tr>`);
  h+='</tbody></table>'; el.innerHTML=h;
}

/* Agenda */
function openAddEvent(){
  const id=uid('evt');
  $('#modalTitle').innerText='Nueva cita';
  $('#modalBody').innerHTML=`
    <div class="row">
      <input id="evtCliente" placeholder="Cliente">
      <input id="evtTel" placeholder="Tel√©fono">
    </div>
    <div class="row" style="margin-top:8px">
      <input id="evtTitle" placeholder="Servicio (ej: Mantenimiento)">
      <input type="date" id="evtDate">
      <input type="time" id="evtTime">
      <input type="number" id="evtDuration" min="15" step="15" value="60" placeholder="Duraci√≥n (min)">
    </div>
    <textarea id="evtNotes" style="margin-top:8px" placeholder="Notas"></textarea>
    <div class="row" style="margin-top:10px">
      <button class="btn brand" onclick="saveEvent('${id}')">Guardar</button>
    </div>
  `;
  $('#modal').classList.remove('hide');
}
function saveEvent(id){
  const date=$('#evtDate').value, time=$('#evtTime').value;
  if(!date || !time){ alert('Fecha y hora obligatorias'); return; }
  const e={id,cliente:$('#evtCliente').value||'Cliente',telefono:$('#evtTel').value||'',title:$('#evtTitle').value||'Cita',date,time,duration:parseInt($('#evtDuration').value||60,10),notes:$('#evtNotes').value||'',createdAt:Date.now()};
  const all=LS.get('events',[]); all.push(e); LS.set('events',all); closeModal(); renderEvents(); recomputeAnalytics(); openCalendarPrompt(e);
}
function openCalendarPrompt(evt){
  const s=new Date(`${evt.date}T${evt.time}:00`), e=new Date(s.getTime()+evt.duration*60000);
  const pad=n=>String(n).padStart(2,'0'), iso=d=>`${d.getUTCFullYear()}${pad(d.getUTCMonth()+1)}${pad(d.getUTCDate())}T${pad(d.getUTCHours())}${pad(d.getUTCMinutes())}00Z`;
  const text=encodeURIComponent(evt.title), details=encodeURIComponent((evt.notes||'')+(evt.telefono?`\nTel: ${evt.telefono}`:'')), location=encodeURIComponent('');
  const url=`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${iso(s)}/${iso(e)}&details=${details}&location=${location}`;
  if(confirm('¬øAbrir Google Calendar para a√±adir la cita?')) window.open(url,'_blank');
  // Descargar .ics
  const dt=d=>`${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}T${pad(d.getHours())}${pad(d.getMinutes())}00`;
  const ics=`BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
DTSTART:${dt(s)}
DTEND:${dt(e)}
SUMMARY:${evt.title}
DESCRIPTION:${evt.notes||''}
END:VEVENT
END:VCALENDAR`.replace(/\n/g,"\r\n");
  const a=document.createElement('a'); a.href='data:text/calendar;charset=utf-8,'+encodeURIComponent(ics); a.download=`cita_${evt.date}_${evt.time}.ics`; a.click();
}
function renderEvents(){
  const q=($('#agendaFilter').value||'').toLowerCase();
  const list=LS.get('events',[]).filter(x=>[x.cliente,x.title,x.date,x.time,x.telefono].join(' ').toLowerCase().includes(q)).sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));
  $('#agendaCount').innerText=`${list.length} citas`;
  if(!list.length){ $('#agendaTable').innerHTML='<div class="pill">No hay citas.</div>'; return;}
  let h=`<table><thead><tr><th>Fecha</th><th>Hora</th><th>Cliente</th><th>Servicio</th><th>Tel</th><th></th></tr></thead><tbody>`;
  list.forEach(e=>h+=`<tr><td>${e.date}</td><td>${e.time}</td><td>${esc(e.cliente)}</td><td>${esc(e.title)}</td><td>${esc(e.telefono)}</td>
  <td class="right"><button class="btn small" onclick='openCalendarPrompt(${JSON.stringify(e)})'>Google</button>
  <button class="btn small warn" onclick='editEvent("${e.id}")'>Editar</button>
  <button class="btn small danger" onclick='delEvent("${e.id}")'>Eliminar</button></td></tr>`);
  h+='</tbody></table>'; $('#agendaTable').innerHTML=h;
}
function editEvent(id){
  const e=LS.get('events',[]).find(x=>x.id===id); if(!e) return;
  $('#modalTitle').innerText='Editar cita';
  $('#modalBody').innerHTML=`
    <div class="row"><input id="evtCliente" value="${esc(e.cliente)}"><input id="evtTel" value="${esc(e.telefono)}"></div>
    <div class="row" style="margin-top:8px"><input id="evtTitle" value="${esc(e.title)}"><input type="date" id="evtDate" value="${e.date}"><input type="time" id="evtTime" value="${e.time}"><input type="number" id="evtDuration" value="${e.duration}"></div>
    <textarea id="evtNotes" style="margin-top:8px">${esc(e.notes)}</textarea>
    <div class="row" style="margin-top:10px"><button class="btn brand" onclick="applyEvent('${id}')">Guardar</button></div>`;
  $('#modal').classList.remove('hide');
}
function applyEvent(id){ const all=LS.get('events',[]); const i=all.findIndex(x=>x.id===id); if(i<0) return;
  all[i].cliente=$('#evtCliente').value; all[i].telefono=$('#evtTel').value; all[i].title=$('#evtTitle').value; all[i].date=$('#evtDate').value; all[i].time=$('#evtTime').value; all[i].duration=parseInt($('#evtDuration').value||60,10); all[i].notes=$('#evtNotes').value;
  LS.set('events',all); closeModal(); renderEvents(); }
function delEvent(id){ if(!confirm('Eliminar?')) return; LS.set('events',LS.get('events',[]).filter(x=>x.id!==id)); renderEvents(); recomputeAnalytics(); }

/* Contactos */
function renderContacts(){const list=LS.get('contacts',[]); if(!list.length){$('#contactsTable').innerHTML='<div class="pill">No hay contactos.</div>'; return;} let h=`<table><thead><tr><th>Nombre</th><th>Tel√©fono</th><th>Email</th><th>Direcci√≥n</th><th></th></tr></thead><tbody>`; list.forEach(c=>h+=`<tr><td>${esc(c.nombre||'')}</td><td>${esc(c.telefono||'')}</td><td>${esc(c.email||'')}</td><td>${esc(c.direccion||'')}</td><td class="right"><button class="btn small warn" onclick='editContact("${c.id}")'>Editar</button><button class="btn small danger" onclick='delContact("${c.id}")'>Eliminar</button></td></tr>`); h+='</tbody></table>'; $('#contactsTable').innerHTML=h; }
function addContact(){const c={id:uid('c'),nombre:$('#cName').value,telefono:$('#cPhone').value,email:$('#cEmail').value,direccion:$('#cAddr').value}; const list=LS.get('contacts',[]); list.push(c); LS.set('contacts',list); $('#cName').value=$('#cPhone').value=$('#cEmail').value=$('#cAddr').value=''; renderContacts();}
function editContact(id){const c=LS.get('contacts',[]).find(x=>x.id===id); $('#modalTitle').innerText='Editar contacto'; $('#modalBody').innerHTML=`<input id="ecName" value="${esc(c.nombre)}"><input id="ecPhone" value="${esc(c.telefono)}"><input id="ecEmail" value="${esc(c.email)}"><input id="ecAddr" value="${esc(c.direccion)}"><div class="row" style="margin-top:10px"><button class="btn brand" onclick="applyContact('${id}')">Guardar</button></div>`; $('#modal').classList.remove('hide');}
function applyContact(id){const list=LS.get('contacts',[]); const i=list.findIndex(x=>x.id===id); list[i].nombre=$('#ecName').value; list[i].telefono=$('#ecPhone').value; list[i].email=$('#ecEmail').value; list[i].direccion=$('#ecAddr').value; LS.set('contacts',list); closeModal(); renderContacts();}
function delContact(id){ if(!confirm('Eliminar?')) return; LS.set('contacts',LS.get('contacts',[]).filter(x=>x.id!==id)); renderContacts(); }
function importContacts(ev){ const f=ev.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=e=>{ try{ let arr=[]; if(f.name.endsWith('.json')) arr=JSON.parse(e.target.result); else arr=parseCSV(e.target.result).map(o=>({nombre:o.nombre||o.name||'',telefono:o.telefono||o.phone||'',email:o.email||'',direccion:o.direccion||o.address||''})); const list=LS.get('contacts',[]); arr.forEach(x=>list.push({id:uid('c'),...x})); LS.set('contacts',list); renderContacts(); alert('Contactos importados.'); }catch(err){alert('Error importando: '+err.message)} }; r.readAsText(f); }

/* C√≥digos */
function updateCounts(){ $('#codesCount').innerText=`${LS.get('codes',[]).length} c√≥digos` }
function addCode(){ const r={marca:$('#mBrand').value,codigo:$('#mCode').value,descripcion:$('#mDesc').value,solucion:$('#mFix').value,tipo_falla:$('#mType').value,nivel:$('#mLevel').value,nota:$('#mNote').value}; const list=LS.get('codes',[]); list.push(r); LS.set('codes',list); updateCounts(); alert('C√≥digo a√±adido'); $('#mBrand').value=$('#mCode').value=$('#mDesc').value=$('#mFix').value=$('#mType').value=$('#mLevel').value=$('#mNote').value=''; }
function importCodes(ev){ const f=ev.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=e=>{ try{ let arr=[]; if(f.name.endsWith('.json')) arr=JSON.parse(e.target.result); else arr=parseCSV(e.target.result); const list=LS.get('codes',[]); arr.forEach(x=>list.push(x)); LS.set('codes',list); updateCounts(); alert('C√≥digos importados.'); }catch(err){ alert('Error importando: '+err.message) } }; r.readAsText(f); }

/* Docs (Cotizaciones/Facturas) */
function openDocForm(kind,id=null){
  const doc = id? LS.get(kind+'s',[]).find(x=>x.id===id) : null;
  const contacts = LS.get('contacts',[]);
  const items = doc?.items || [{desc:'Servicio',qty:1,price:0}];
  const useBiz = doc ? !!doc.useBizFooter : true;
  const F = doc?.footer || {};
  $('#modalTitle').innerText = (id?'Editar ':'Nueva ') + (kind==='quote'?'Cotizaci√≥n':'Factura');
  $('#modalBody').innerHTML = `
    <div class="row">
      <select id="docContact">${contacts.map(c=>`<option value="${c.id}" ${(doc&&doc.contactId===c.id)?'selected':''}>${esc(c.nombre||'Sin nombre')} (${esc(c.telefono||'')})</option>`).join('')}</select>
      <input id="dTitle" placeholder="${kind==='quote'?'Cotizaci√≥n':'Factura'}" value="${esc(doc?.title||'')}">
      <input id="dNum" placeholder="${kind==='quote'?'#Cotizaci√≥n':'#Factura'}" value="${esc(doc?.number||'')}">
    </div>
    <table id="itemsTbl" style="margin-top:8px"><thead><tr><th>Descripci√≥n</th><th>Cant.</th><th>Precio</th><th></th></tr></thead><tbody>
      ${items.map(it=>rowItem(it.desc,it.qty,it.price)).join('')}
    </tbody></table>
    <div class="row" style="margin-top:8px"><button class="btn small" onclick="addRow()">+ √çtem</button></div>
    <div class="row" style="margin-top:8px">
      <input id="dTax" type="number" step="0.01" value="${esc(doc?.tax??'11.5')}" placeholder="IVU %">
      <label style="display:flex;align-items:center;gap:8px"><input id="dPaid" type="checkbox" ${doc?.paid?'checked':''}> <b>PAGADO</b></label>
    </div>
    <div class="row" style="margin-top:8px">
      <label style="display:flex;gap:8px;align-items:center"><input type="radio" name="fmode" value="biz" ${useBiz?'checked':''} onchange="toggleFooter(true)"> Usar datos globales</label>
      <label style="display:flex;gap:8px;align-items:center"><input type="radio" name="fmode" value="custom" ${!useBiz?'checked':''} onchange="toggleFooter(false)"> Personalizar este documento</label>
    </div>
    <div id="footerBox" class="${useBiz?'hide':''}" style="margin-top:6px">
      <div class="row">
        <div style="flex:1 1 220px">
          <label>Logo del documento</label>
          <input type="file" accept="image/*" id="dLogoIn" onchange="loadDocLogo(event)">
          <div class="row" style="margin-top:6px"><img id="dLogoPrev" style="max-width:170px;max-height:84px" src="${F.logo||''}" alt=""></div>
        </div>
        <div style="flex:2 1 360px">
          <label>Nombre</label><input id="fName" value="${esc(F.name||'')}">
          <label>Tel√©fono</label><input id="fPhone" value="${esc(F.phone||'')}">
          <label>Sitio web</label><input id="fWeb" value="${esc(F.web||'')}">
          <label>Direcci√≥n</label><input id="fAddr" value="${esc(F.addr||'')}">
        </div>
      </div>
    </div>
    <div style="margin-top:8px"><label>Notas / T√©rminos</label><textarea id="dTerms">${esc(doc?.terms||'Formas de pago: ATH M√≥vil, cheque, efectivo, transferencia, tarjetas. Precios sujetos a IVU y disponibilidad. Garant√≠a seg√∫n fabricante y t√©rminos acordados.')}</textarea></div>
    <div style="margin-top:8px"><label>Firma del cliente</label>
      <div style="border:1px solid #234;border-radius:12px;background:#0d1f2d;padding:8px">
        <canvas id="sigPad" width="780" height="180" style="width:100%;height:180px;border-radius:8px;background:#fff"></canvas>
        <div class="row" style="margin-top:6px"><button class="btn small" onclick="sigClear()">Borrar</button><button class="btn small brand" onclick="sigSave()">Usar firma</button><span id="sigState" class="pill">Sin firma</span></div>
      </div>
    </div>
    <div class="row" style="margin-top:12px"><button class="btn brand" onclick="saveDoc('${kind}','${id||''}')">Guardar</button></div>
  `;
  $('#modal').classList.remove('hide');
  // firma
  prepSignaturePad();
  if(doc?.signature){ _sigDataURL=doc.signature; $('#sigState').textContent='Firma cargada'; }
  // guardar logo temp
  if(F.logo) document.getElementById('dLogoIn')?.setAttribute('data-img',F.logo);
}
function rowItem(desc='',qty=1,price=0){return `<tr><td><input value="${esc(desc)}" data-k="desc"></td><td style="max-width:120px"><input type="number" step="0.01" value="${qty}" data-k="qty"></td><td style="max-width:140px"><input type="number" step="0.01" value="${price}" data-k="price"></td><td><button class="btn small danger" onclick="this.closest('tr').remove()">‚Äì</button></td></tr>`}
function addRow(){ $('#itemsTbl tbody').insertAdjacentHTML('beforeend',rowItem()) }
function collectItems(){ return [...document.querySelectorAll('#itemsTbl tbody tr')].map(tr=>({desc:tr.querySelector('[data-k="desc"]').value,qty:parseFloat(tr.querySelector('[data-k="qty"]').value||0),price:parseFloat(tr.querySelector('[data-k="price"]').value||0)})).filter(x=>x.desc) }
function toggleFooter(useBiz){ useBiz?$('#footerBox').classList.add('hide'):$('#footerBox').classList.remove('hide') }
function loadDocLogo(ev){ const f=ev.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=e=>{ $('#dLogoPrev').src=e.target.result; ev.target.dataset.img=e.target.result; }; r.readAsDataURL(f); }
function saveDoc(kind,id){
  const all=LS.get(kind+'s',[]);
  const useBiz=document.querySelector('input[name="fmode"][value="biz"]').checked;
  const footer=useBiz?null:{logo:document.getElementById('dLogoIn')?.dataset.img||'',name:$('#fName').value||'',phone:$('#fPhone').value||'',web:$('#fWeb').value||'',addr:$('#fAddr').value||''};
  const items=collectItems(); const sub=items.reduce((a,b)=>a+b.qty*b.price,0); const tax=parseFloat($('#dTax').value||0); const total=sub*(1+tax/100);
  const obj={id:id||uid(kind),kind,createdAt:Date.now(),contactId:$('#docContact')?.value||null,title:$('#dTitle').value||(kind==='quote'?'Cotizaci√≥n':'Factura'),number:$('#dNum').value||'',items,sub,tax,total,terms:$('#dTerms').value||'',paid:$('#dPaid').checked||false,signature:_sigDataURL|| (all.find(x=>x.id===id)?.signature||null),useBizFooter:useBiz,footer};
  const i=all.findIndex(x=>x.id===obj.id); if(i>=0) all[i]=obj; else all.push(obj); LS.set(kind+'s',all); closeModal(); renderDocs(kind); recomputeAnalytics();
}
function renderDocs(kind){
  const list=LS.get(kind+'s',[]); const target=(kind==='quote')?'#quotesTable':'#invoicesTable';
  if(!list.length){ $(target).innerHTML='<div class="pill">No hay documentos.</div>'; return; }
  const contacts=LS.get('contacts',[]);
  let h=`<table><thead><tr><th>Fecha</th><th>#</th><th>T√≠tulo</th><th>Cliente</th><th>Total</th><th></th></tr></thead><tbody>`;
  list.sort((a,b)=>b.createdAt-a.createdAt).forEach(d=>{ const c=contacts.find(x=>x.id===d.contactId)||{}; h+=`<tr><td>${new Date(d.createdAt).toLocaleDateString()}</td><td>${esc(d.number||'')}</td><td>${esc(d.title)}</td><td>${esc(c.nombre||'')}</td><td>${money(d.total)}</td><td class="right"><button class="btn small" onclick="openDocForm('${kind}','${d.id}')">Editar</button><button class="btn small" onclick="openPDF('${kind}','${d.id}')">Ver/Exportar PDF</button><button class="btn small danger" onclick="delDoc('${kind}','${d.id}')">Eliminar</button></td></tr>`});
  h+='</tbody></table>'; $(target).innerHTML=h;
}
function delDoc(kind,id){ if(!confirm('Eliminar documento?')) return; LS.set(kind+'s',LS.get(kind+'s',[]).filter(x=>x.id!==id)); renderDocs(kind); recomputeAnalytics(); }
function openPDF(kind,id){
  const d=LS.get(kind+'s',[]).find(x=>x.id===id); if(!d) return;
  const biz=LS.get('biz'); const F=d.useBizFooter?biz:{...biz,...d.footer};
  const logoTag=(d.useBizFooter?biz.logo:d.footer?.logo)?`<img src="${d.useBizFooter?biz.logo:d.footer.logo}" alt="logo">`:''; 
  const items=d.items?.length?d.items:[{desc:'Servicio',qty:1,price:0}];
  const sub=d.sub??items.reduce((a,b)=>a+b.qty*b.price,0), tax=d.tax??0, total=sub*(1+tax/100);
  const rows=items.map(x=>`<tr><td>${esc(x.desc)}</td><td>${x.qty}</td><td>${money(x.price)}</td><td>${money(x.qty*x.price)}</td></tr>`).join('');
  const stamp=d.paid?`<div class="stamp">PAGADO</div>`:'';
  const sign=d.signature?`<div class="p-sign"><strong>Firma del cliente:</strong><img src="${d.signature}" alt="firma"></div>`:'';
  $('#printView').innerHTML=`
    <div style="position:relative">
      ${stamp}
      <div class="p-head">
        <div class="brand">${logoTag}<div class="biz"><div><b>${esc(F.name||biz.name)}</b></div><div>${esc(F.phone||biz.phone)} ¬∑ ${esc(F.web||biz.web)}</div><div>${esc(F.addr||biz.addr)}</div></div></div>
        <div class="p-sub"><div><b>${esc(d.title)} ${d.number?('#'+esc(d.number)):""}</b></div><div>${new Date(d.createdAt).toLocaleDateString()}</div></div>
      </div>
      <div class="p-line"></div>
      <table class="p-table"><thead><tr><th align="left">Descripci√≥n</th><th>Cant.</th><th>Precio</th><th>Importe</th></tr></thead><tbody>${rows}</tbody>
        <tfoot><tr class="p-total"><td colspan="3" align="right"><b>Subtotal</b></td><td>${money(sub)}</td></tr>
        <tr><td colspan="3" align="right">IVU ${tax}%</td><td>${money(sub*(tax/100))}</td></tr>
        <tr><td colspan="3" align="right"><b>Total</b></td><td><b>${money(total)}</b></td></tr></tfoot></table>
      ${d.terms?`<div class="p-notes"><b>T√©rminos:</b> ${esc(d.terms)}</div>`:''}
      ${sign}
      <div class="p-footer"><span>Gracias por su preferencia.</span><span>${esc(F.web||biz.web)} ¬∑ ${esc(F.phone||biz.phone)}</span></div>
    </div>`;
  window.print();
}

/* Firma t√°ctil */
let _sigPad,_sigCtx,_drawing=false,_sigDataURL=null;
function prepSignaturePad(){
  _sigPad=document.getElementById('sigPad'); if(!_sigPad) return;
  _sigCtx=_sigPad.getContext('2d'); _sigCtx.strokeStyle='#111'; _sigCtx.lineWidth=2; _sigCtx.lineJoin='round'; _sigCtx.lineCap='round';
  const pos=e=>{const r=_sigPad.getBoundingClientRect();const t=(e.touches?e.touches[0]:e);return {x:(t.clientX-r.left)*(_sigPad.width/r.width),y:(t.clientY-r.top)*(_sigPad.height/r.height)}}
  const start=e=>{_drawing=true;const p=pos(e);_sigCtx.beginPath();_sigCtx.moveTo(p.x,p.y);e.preventDefault();}
  const move =e=>{if(!_drawing)return;const p=pos(e);_sigCtx.lineTo(p.x,p.y);_sigCtx.stroke();e.preventDefault();}
  const end  =e=>{_drawing=false;e.preventDefault();}
  _sigPad.addEventListener('mousedown',start); _sigPad.addEventListener('mousemove',move); window.addEventListener('mouseup',end);
  _sigPad.addEventListener('touchstart',start,{passive:false}); _sigPad.addEventListener('touchmove',move,{passive:false}); _sigPad.addEventListener('touchend',end,{passive:false});
}
function sigClear(){ _sigCtx.clearRect(0,0,_sigPad.width,_sigPad.height); _sigDataURL=null; $('#sigState').textContent='Sin firma'; }
function sigSave(){ _sigDataURL=_sigPad.toDataURL('image/png'); $('#sigState').textContent='Firma guardada'; }

/* Rendimientos */
function recomputeAnalytics(){
  const Q=LS.get('quotes',[]), I=LS.get('invoices',[]), E=LS.get('events',[]);
  const sumQ=Q.reduce((a,b)=>a+b.total,0), sumI=I.reduce((a,b)=>a+b.total,0);
  $('#analyticsSummary').innerHTML=`<span class="pill">Cotizaciones: <b>${Q.length}</b> | ${money(sumQ)}</span>
  <span class="pill">Facturas: <b>${I.length}</b> | ${money(sumI)}</span>
  <span class="pill">Citas: <b>${E.length}</b></span>
  <span class="pill">Ticket promedio factura: <b>${money(I.length?sumI/I.length:0)}</b></span>`;
  drawTrendChart('chart1',Q,I,E);
}
function drawTrendChart(id,Q,I,E){
  const ctx=document.getElementById(id).getContext('2d'); const now=new Date(); const months=[];
  for(let i=11;i>=0;i--){const d=new Date(now.getFullYear(),now.getMonth()-i,1); months.push({k:d.toISOString().slice(0,7),q:0,i:0,e:0});}
  const bump=(arr,prop,ts)=>{const k=new Date(ts).toISOString().slice(0,7); const m=months.find(x=>x.k===k); if(m) m[prop]++; };
  Q.forEach(x=>bump(months,'q',x.createdAt)); I.forEach(x=>bump(months,'i',x.createdAt)); E.forEach(x=>bump(months,'e',new Date(`${x.date}T${x.time}:00`).getTime()));
  ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height); const W=ctx.canvas.width,H=ctx.canvas.height,P=30; ctx.strokeStyle='#335c7a'; ctx.strokeRect(P,P,W-2*P,H-2*P);
  const ys=[...months.map(m=>m.q),...months.map(m=>m.i),...months.map(m=>m.e)]; const max=Math.max(1,...ys); const stepX=(W-2*P)/(months.length-1);
  function line(prop,w){ctx.lineWidth=w;ctx.beginPath();months.forEach((m,idx)=>{const x=P+idx*stepX; const y=H-P-(m[prop]/max)*(H-2*P); idx?ctx.lineTo(x,y):ctx.moveTo(x,y)});ctx.stroke();}
  ctx.fillStyle='#88a9bf'; ctx.font='12px system-ui'; months.forEach((m,idx)=>{const x=P+idx*stepX; if(idx%2===0) ctx.fillText(m.k.slice(2),x-12,H-8);});
  line('q',2); line('i',2.5); line('e',1.5); ctx.fillText('Q=cot, I=fact, E=citas',W-170,P-8);
}

/* CSV simple */
function parseCSV(text){const lines=text.split(/\r?\n/).filter(Boolean); if(!lines.length) return []; const headers=lines[0].split(',').map(h=>h.trim().toLowerCase()); return lines.slice(1).map(line=>{const cols=splitCSVLine(line); const obj={}; headers.forEach((h,i)=>obj[h]=(cols[i]||'').trim()); return obj;});}
function splitCSVLine(line){const out=[]; let cur='',inQ=false; for(let i=0;i<line.length;i++){const ch=line[i]; if(ch==='"'){ if(inQ && line[i+1]==='"'){cur+='"'; i++;} else inQ=!inQ; } else if(ch===',' && !inQ){ out.push(cur); cur=''; } else cur+=ch;} out.push(cur); return out;}

/* Modal */
function closeModal(){ $('#modal').classList.add('hide'); $('#modalBody').innerHTML=''; }
</script>
</body>
</html>

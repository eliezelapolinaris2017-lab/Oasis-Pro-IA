<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OASIS PRO IA ‚Äî Men√∫</title>
<style>
  :root{
    --bg:#0b1624; --panel:#122033; --panel-2:#0f1b2b; --muted:#8aa0c6; --text:#e9eef8;
    --primary:#3aa0ff; --primary-2:#00c2ff; --card-radius:16px; --shadow:0 10px 24px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:radial-gradient(1200px 700px at -200px -100px, rgba(10,70,120,.25), transparent 70%),var(--bg);color:var(--text)}
  a{color:var(--primary);text-decoration:none}
  .topbar{position:sticky; top:0; z-index:5; display:flex; align-items:center; gap:12px; padding:16px 18px; background:linear-gradient(180deg, rgba(7,15,25,.8), rgba(7,15,25,.4)); backdrop-filter: blur(6px); border-bottom:1px solid rgba(255,255,255,.06)}
  .logo{ width:40px; height:40px; border-radius:12px; background: conic-gradient(from 60deg, #00c2ff, #1986ff, #00c2ff); display:grid; place-items:center; box-shadow:0 8px 18px rgba(0,140,255,.35) inset, 0 0 0 1px rgba(255,255,255,.06);}
  .logo svg{width:24px; height:24px}
  .brand{font-weight:800; letter-spacing:.3px}
  .brand small{display:block; color:#c6d5ee; opacity:.85; margin-top:2px}
  .spacer{flex:1}
  .btn{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(90deg,var(--primary),var(--primary-2));border:none;color:#00122a;font-weight:800;padding:10px 14px;border-radius:12px;cursor:pointer;box-shadow:0 8px 18px rgba(0,162,255,.35)}
  .btn.secondary{background:#0f1c2d;color:#d8e6ff;border:1px solid rgba(255,255,255,.08);box-shadow:none}
  .layout{display:grid; grid-template-columns: 280px 1fr; min-height: calc(100vh - 72px);}
  .menu{border-right:1px solid rgba(255,255,255,.06);background:linear-gradient(180deg,var(--panel-2),#0c1a2a 60%, #0a1626);padding:18px;}
  .menu h2{margin:6px 0 10px 6px; font-size:14px; color:#bcd0ef; letter-spacing:.2px}
  .menu ul{list-style:none; margin:0; padding:0; display:grid; gap:8px}
  .menu li a{display:flex; gap:12px; align-items:center; padding:12px; border-radius:12px; color:#c5d2ea;}
  .menu li a:hover{background:rgba(255,255,255,.07); color:#fff}
  .menu .icon{width:26px; height:26px; display:grid; place-items:center; border-radius:10px; background:rgba(0,194,255,.15);}
  .content{padding:24px; display:grid; gap:22px}
  .card{background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00)), var(--panel); border-radius:var(--card-radius); padding:18px; box-shadow:var(--shadow); border:1px solid rgba(255,255,255,.06)}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:16px}
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:16px}
  .input, select, textarea{ width:100%; padding:12px 14px; border-radius:12px; background:#0e1c2e; border:1px solid rgba(255,255,255,.08); color:var(--text); outline:none;}
  .list{display:grid; gap:10px; max-height:260px; overflow:auto}
  .item{ background:#0f1c2d; border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:10px 12px; display:flex; justify-content:space-between; align-items:center; gap:8px}
  table{ width:100%; border-collapse:collapse; color:var(--text)}
  th,td{ border-bottom:1px solid rgba(255,255,255,.07); padding:8px; text-align:left; }
  .t-right{text-align:right}
  .hidden{display:none !important}
  .menu-grid{display:grid; grid-template-columns:repeat(2,minmax(200px,1fr)); gap:16px}
  .tile{display:flex; align-items:center; gap:12px; padding:16px; border-radius:16px; background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00)), var(--panel); border:1px solid rgba(255,255,255,.06); box-shadow:var(--shadow); cursor:pointer}
  .tile .icon{width:38px; height:38px; border-radius:12px; display:grid; place-items:center; background:rgba(0,194,255,.18)}
  .tile h3{margin:0}
  canvas{width:100%; height:150px; display:block}
  @media (max-width: 1100px){
    .layout{grid-template-columns:1fr}
    .menu{display:none}
    .menu-grid{grid-template-columns:1fr}
    .row, .grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<header class="topbar">
  <div class="logo"><svg viewBox="0 0 24 24" fill="#e9f7ff"><path d="M12 2l1.2 2.9a7.7 7.7 0 013 .9l2.7-1.4 1.6 2.8-2.3 1.9a7.8 7.8 0 01.1 1.1 7.8 7.8 0 01-.1 1.1l2.3 1.9-1.6 2.8-2.7-1.4a7.7 7.7 0 01-3 .9L12 22l-1.2-2.9a7.7 7.7 0 01-3-.9l-2.7 1.4-1.6-2.8 2.3-1.9a7.8 7.8 0 01-.1-1.1 7.8 7.8 0 01.1-1.1L2.5 7.2l1.6-2.8 2.7 1.4a7.7 7.7 0 013-.9L12 2z"/></svg></div>
  <div class="brand">OASIS <small>PRO IA</small></div>
  <div class="spacer"></div>
  <button class="btn secondary" id="btnShowMenu">‚ò∞ Men√∫</button>
</header>

<div class="layout">
  <aside class="menu" id="leftMenu">
    <h2>Men√∫ principal</h2>
    <ul>
      <li><a href="#" data-target="home"><span class="icon">üè†</span> Inicio</a></li>
      <li><a href="#" data-target="diagnostico"><span class="icon">üß∞</span> Diagn√≥stico t√©cnico</a></li>
      <li><a href="#" data-target="agenda"><span class="icon">üóìÔ∏è</span> Agenda</a></li>
      <li><a href="#" data-target="cotizaciones"><span class="icon">üíº</span> Cotizaciones</a></li>
      <li><a href="#" data-target="factura"><span class="icon">üßæ</span> Factura</a></li>
      <li><a href="#" data-target="rendimiento"><span class="icon">üìà</span> Rendimiento</a></li>
      <li><a href="#" data-target="datos"><span class="icon">üóÉÔ∏è</span> Datos</a></li>
    </ul>
  </aside>

  <main class="content">
    <!-- DASHBOARD = MEN√ö -->
    <section id="home" class="section">
      <h2>¬øQu√© deseas hacer?</h2>
      <div class="menu-grid">
        <div class="tile" data-open="diagnostico"><div class="icon">üß∞</div><div><h3>Diagn√≥stico t√©cnico</h3><div class="muted">Buscar y a√±adir c√≥digos de error</div></div></div>
        <div class="tile" data-open="agenda"><div class="icon">üóìÔ∏è</div><div><h3>Agenda</h3><div class="muted">Citas y enlace a Google Calendar</div></div></div>
        <div class="tile" data-open="cotizaciones"><div class="icon">üíº</div><div><h3>Cotizaciones</h3><div class="muted">Multi-√≠tem, PDF y JSON</div></div></div>
        <div class="tile" data-open="factura"><div class="icon">üßæ</div><div><h3>Factura r√°pida</h3><div class="muted">Multi-√≠tem, PDF</div></div></div>
        <div class="tile" data-open="rendimiento"><div class="icon">üìà</div><div><h3>Rendimiento</h3><div class="muted">KPIs y gr√°fico</div></div></div>
        <div class="tile" data-open="datos"><div class="icon">üóÉÔ∏è</div><div><h3>Datos</h3><div class="muted">Importar/Exportar DB</div></div></div>
      </div>
    </section>

    <!-- DIAGN√ìSTICO -->
    <section id="diagnostico" class="section hidden">
      <div class="grid">
        <div class="card">
          <h3>Buscar</h3>
          <div class="row">
            <div><label class="muted">Marca</label><input id="dg-marca" class="input"></div>
            <div><label class="muted">C√≥digo o s√≠ntoma</label><input id="dg-q" class="input" placeholder="E1 / no enfr√≠a / etc."></div>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" id="dg-buscar">Diagnosticar</button>
            <button class="btn secondary" id="dg-limpiar" style="margin-left:auto">Limpiar</button>
          </div>
          <div id="dg-res" class="list" style="margin-top:10px"></div>
        </div>
        <div class="card">
          <h3>Base de datos ‚Äî A√±adir/Editar</h3>
          <div class="row">
            <div><label class="muted">Marca</label><input id="db-marca" class="input"></div>
            <div><label class="muted">C√≥digo</label><input id="db-codigo" class="input"></div>
          </div>
          <label class="muted">Nombre / Causa</label><input id="db-nombre" class="input">
          <label class="muted">S√≠ntomas (separados por coma)</label><input id="db-sint" class="input">
          <label class="muted">Pasos (uno por l√≠nea)</label><textarea id="db-pasos" class="input" rows="4"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" id="db-guardar">Guardar/Actualizar</button>
            <button class="btn secondary" id="db-borrar">Eliminar</button>
            <button class="btn secondary" id="db-export">Exportar JSON</button>
            <label class="btn secondary"><input type="file" id="db-import" accept="application/json" style="display:none"> Importar JSON</label>
          </div>
          <div id="db-list" class="list" style="margin-top:10px"></div>
        </div>
      </div>
    </section>

    <!-- AGENDA -->
    <section id="agenda" class="section hidden">
      <div class="card">
        <h3>Nueva cita</h3>
        <div class="row">
          <div><label class="muted">Fecha</label><input id="c-fecha" type="date" class="input"></div>
          <div><label class="muted">Inicio</label><input id="c-hora" type="time" class="input" value="09:00"></div>
          <div><label class="muted">Fin</label><input id="c-hora-fin" type="time" class="input" value="10:00"></div>
        </div>
        <div class="row">
          <div><label class="muted">Cliente</label><input id="c-cliente" class="input"></div>
          <div><label class="muted">Servicio</label><input id="c-serv" class="input"></div>
        </div>
        <label class="muted">Notas</label><input id="c-notas" class="input">
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="c-guardar">Guardar</button>
          <a class="btn secondary" id="c-url" target="_blank">Google Calendar (URL)</a>
        </div>
      </div>
      <div class="card">
        <h3>Citas guardadas</h3>
        <div id="citas-list" class="list"></div>
      </div>
    </section>

    <!-- COTIZACIONES -->
    <section id="cotizaciones" class="section hidden">
      <div class="card">
        <h3>Cotizaci√≥n (m√∫ltiples √≠tems)</h3>
        <div class="row">
          <div><label class="muted">Cliente</label><input id="q-cliente" class="input"></div>
          <div><label class="muted">Aplicar IVU 11.5%</label><select id="q-ivu" class="input"><option value="si">S√≠</option><option value="no">No</option></select></div>
        </div>
        <label class="muted">Descripci√≥n general</label><input id="q-desc" class="input">
        <table id="q-items" style="margin-top:10px">
          <thead><tr><th>√çtem</th><th style="width:100px">Cant.</th><th style="width:140px">Precio</th><th class="t-right" style="width:140px">Subtotal</th><th style="width:60px"></th></tr></thead>
          <tbody></tbody>
        </table>
        <div style="display:flex;gap:16px;justify-content:flex-end;margin-top:10px">
          <div>Subtotal: <b id="q-st">$0</b></div>
          <div>IVU: <b id="q-ivu-v">$0</b></div>
          <div>Total: <b id="q-total">$0</b></div>
        </div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn" id="q-add">A√±adir √≠tem</button>
          <button class="btn" id="q-save">Guardar</button>
          <button class="btn secondary" id="q-print">Exportar PDF</button>
          <button class="btn secondary" id="q-export">Exportar JSON</button>
        </div>
      </div>
      <div class="card">
        <h3>Historial</h3>
        <div id="q-hist" class="list"></div>
      </div>
    </section>

    <!-- FACTURA -->
    <section id="factura" class="section hidden">
      <div class="card">
        <h3>Factura r√°pida</h3>
        <div class="row">
          <div><label class="muted">Cliente</label><input id="f-cliente" class="input"></div>
          <div><label class="muted">No. Factura</label><input id="f-num" class="input" placeholder="000001"></div>
        </div>
        <table id="f-items" style="margin-top:10px">
          <thead><tr><th>√çtem</th><th style="width:100px">Cant.</th><th style="width:140px">Precio</th><th class="t-right" style="width:140px">Subtotal</th><th style="width:60px"></th></tr></thead>
          <tbody></tbody>
        </table>
        <div style="display:flex;gap:16px;justify-content:flex-end;margin-top:10px">
          <div>Subtotal: <b id="f-st">$0</b></div>
          <div>IVU: <b id="f-ivu">$0</b></div>
          <div>Total: <b id="f-total">$0</b></div>
        </div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn" id="f-add">A√±adir √≠tem</button>
          <button class="btn secondary" id="f-print">Exportar PDF</button>
        </div>
      </div>
    </section>

    <!-- RENDIMIENTO -->
    <section id="rendimiento" class="section hidden">
      <div class="card">
        <h3>Indicadores</h3>
        <div class="grid">
          <div class="card" style="background:#0e1b2b"><div>Tickets (30d)<br><b id="r-tickets">0</b></div></div>
          <div class="card" style="background:#0e1b2b"><div>Ingresos Mes<br><b id="r-ingresos">$0</b></div></div>
        </div>
        <canvas id="r-chart" width="700" height="160"></canvas>
      </div>
    </section>

    <!-- DATOS -->
    <section id="datos" class="section hidden">
      <div class="card">
        <h3>Datos guardados</h3>
        <div id="db-count" class="muted"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn secondary" id="db-export2">Exportar DB</button>
          <label class="btn secondary"><input type="file" id="db-import2" accept="application/json" style="display:none"> Importar DB</label>
        </div>
      </div>
    </section>

  </main>
</div>

<script>
/* ===== Helpers ===== */
const $ = s=>document.querySelector(s);
const $$ = s=>document.querySelectorAll(s);
const LS = { get:k=>JSON.parse(localStorage.getItem(k)||'null'), set:(k,v)=>localStorage.setItem(k, JSON.stringify(v)) };
const money = n => new Intl.NumberFormat('es-PR', {style:'currency', currency:'USD'}).format(n||0);

/* Open/close left menu on mobile */
$("#btnShowMenu").onclick = ()=>{ const el=$("#leftMenu"); el.style.display = getComputedStyle(el).display==="none"?"block":"none"; };

/* Route to section */
function route(id){
  $$(".section").forEach(s=>s.classList.add("hidden"));
  $("#"+id).classList.remove("hidden");
  if(innerWidth<=1100) $("#leftMenu").style.display="none";
}
$("#leftMenu").addEventListener("click", (e)=>{
  const a = e.target.closest("a[data-target]"); if(!a) return;
  e.preventDefault(); route(a.dataset.target);
});
$$(".tile").forEach(t=> t.onclick = ()=> route(t.dataset.open));

/* ===== Data ===== */
let DB = LS.get("oasisDB") || [
  {marca:"TGM", codigo:"E1", nombre:"Error de comunicaci√≥n", sintomas:["no enciende U.E.","parpadeo tablero"], pasos:["Verifica cable entre U.I. y U.E.","Revisa S1/S2/S3","Resetea 5 min","Posible placa exterior"]},
  {marca:"Midea", codigo:"F0", nombre:"Refrigerante bajo / Fuga", sintomas:["no enfr√≠a","hielo en tuber√≠a"], pasos:["Prueba de fuga 400 psi","Vac√≠o < 500 micrones","Carga por peso"]}
];
let citas = LS.get("oasisCitas") || [];
let quotes = LS.get("oasisQuotesV3") || [];

/* ===== Diagn√≥stico ===== */
function buscarDiag(q, marca){
  q=(q||"").toLowerCase().trim();
  return DB.filter(r=>
    (!marca || r.marca.toLowerCase()===marca.toLowerCase()) &&
    (r.codigo.toLowerCase()===q || r.nombre.toLowerCase().includes(q) || r.sintomas.some(s=>s.toLowerCase().includes(q)))
  );
}
function renderDiagList(list, target){
  target.innerHTML = list.length? list.map((r,i)=>'<div class="item" style="align-items:flex-start"><div><b>['+r.marca+'] '+r.codigo+'</b> ‚Äî '+r.nombre+'<br><span class="muted">'+r.sintomas.join(" ¬∑ ")+'</span><ol style="margin:6px 0 0 18px">'+r.pasos.map(p=>'<li>'+p+'</li>').join("")+'</ol></div><button class="btn secondary" onclick="loadDB('+i+')">Editar</button></div>').join("") : '<div class="item"><span class="muted">Sin resultados</span></div>';
}
$("#dg-buscar").onclick = ()=>{ renderDiagList(buscarDiag($("#dg-q").value, $("#dg-marca").value), $("#dg-res")); };
$("#dg-limpiar").onclick = ()=>{ $("#dg-q").value=""; $("#dg-res").innerHTML=""; };

/* CRUD DB */
function loadDB(i){ const r=DB[i]; $("#db-marca").value=r.marca; $("#db-codigo").value=r.codigo; $("#db-nombre").value=r.nombre; $("#db-sint").value=r.sintomas.join(", "); $("#db-pasos").value=r.pasos.join("\n"); }
function saveDB(){ LS.set("oasisDB", DB); renderDB(); updateDBCount(); }
function renderDB(){ $("#db-list").innerHTML = DB.map((r,i)=>'<div class="item"><div><b>['+r.marca+'] '+r.codigo+'</b> ‚Äî '+r.nombre+'</div><button class="btn secondary" onclick="loadDB('+i+')">Editar</button></div>').join(""); }
$("#db-guardar").onclick=()=>{
  const rec={marca:$("#db-marca").value.trim(), codigo:$("#db-codigo").value.trim(), nombre:$("#db-nombre").value.trim(),
    sintomas: $("#db-sint").value.split(",").map(s=>s.trim()).filter(Boolean),
    pasos: $("#db-pasos").value.split("\n").map(s=>s.trim()).filter(Boolean)};
  if(!rec.marca||!rec.codigo){ alert("Marca y C√≥digo son requeridos"); return; }
  const ix = DB.findIndex(x=>x.marca.toLowerCase()===rec.marca.toLowerCase() && x.codigo.toLowerCase()===rec.codigo.toLowerCase());
  if(ix>=0) DB[ix]=rec; else DB.push(rec);
  saveDB(); alert("Guardado");
};
$("#db-borrar").onclick=()=>{
  const marca=$("#db-marca").value.trim(), codigo=$("#db-codigo").value.trim();
  const len=DB.length;
  DB=DB.filter(x=>!(x.marca.toLowerCase()===marca.toLowerCase()&&x.codigo.toLowerCase()===codigo.toLowerCase()));
  if(DB.length<len){ saveDB(); alert("Eliminado"); renderDB(); } else alert("No encontrado");
};
$("#db-export").onclick=()=>{ const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([JSON.stringify(DB,null,2)],{type:"application/json"})); a.download="oasis_codigos_error.json"; a.click(); };
$("#db-import").addEventListener("change", e=>{ const f=e.target.files[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{ try{ DB=JSON.parse(fr.result); saveDB(); alert("Importado"); }catch(_){ alert("JSON inv√°lido"); } }; fr.readAsText(f); });

/* Datos secci√≥n "Datos" */
function updateDBCount(){ $("#db-count").textContent = 'Registros en DB: '+DB.length; }
$("#db-export2").onclick=()=>{ const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([JSON.stringify(DB,null,2)],{type:"application/json"})); a.download="oasis_codigos_error.json"; a.click(); };
$("#db-import2").addEventListener("change", e=>{ const f=e.target.files[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{ try{ DB=JSON.parse(fr.result); saveDB(); alert("Importado"); }catch(_){ alert("JSON inv√°lido"); } }; fr.readAsText(f); });

/* ===== Agenda ===== */
function gcURL(c){ const start=(c.fecha+'T'+c.hora+':00').replace(/[-:]/g,''); const end=(c.fecha+'T'+(c.hora_fin||c.hora)+':00').replace(/[-:]/g,''); const text=encodeURIComponent(c.servicio+' ‚Äî '+c.cliente); const details=encodeURIComponent(c.notas||''); return 'https://calendar.google.com/calendar/u/0/r/eventedit?text='+text+'&dates='+start+'/'+end+'&details='+details; }
function renderCitas(){
  $("#citas-list").innerHTML = citas.slice().reverse().map(c=>'<div class="item"><div><b>'+c.fecha+' '+c.hora+'</b> ¬∑ '+c.cliente+' ‚Äî <span class="muted">'+c.servicio+'</span></div><div style="display:flex;gap:6px"><a class="btn secondary" target="_blank" href="'+gcURL(c)+'">GCal</a><button class="btn secondary" onclick="delCita('+c.id+')">Borrar</button></div></div>').join("") || '<div class="item"><span class="muted">Sin citas</span></div>';
}
function delCita(id){ citas = citas.filter(c=>c.id!==id); LS.set("oasisCitas", citas); renderCitas(); }
$("#c-fecha").value = new Date().toISOString().slice(0,10);
$("#c-guardar").onclick = ()=>{
  const c={id:Date.now(), fecha:$("#c-fecha").value, hora:$("#c-hora").value, hora_fin:$("#c-hora-fin").value, cliente:$("#c-cliente").value, servicio:$("#c-serv").value, notas:$("#c-notas").value};
  citas.push(c); LS.set("oasisCitas", citas); $("#c-url").href = gcURL(c); renderCitas(); alert("Cita guardada");
};
$("#c-url").href="about:blank";

/* ===== Cotizaci√≥n ===== */
function qRow(desc="", qty=1, price=0){
  const tr=document.createElement("tr");
  tr.innerHTML='<td><input class="input q-desc" value="'+desc.replace(/"/g,'&quot;')+'"></td>' +
               '<td><input class="input q-qty" type="number" min="0" step="1" value="'+qty+'"></td>' +
               '<td><input class="input q-price" type="number" step="0.01" value="'+price+'"></td>' +
               '<td class="t-right q-sub">$0</td>' +
               '<td><button class="btn secondary q-del">‚úï</button></td>';
  tr.querySelectorAll("input").forEach(i=>i.addEventListener("input", qRecalc));
  tr.querySelector(".q-del").onclick=()=>{ tr.remove(); qRecalc(); };
  $("#q-items tbody").appendChild(tr); qRecalc();
}
function qRecalc(){
  let st=0;
  $$("#q-items tbody tr").forEach(tr=>{
    const q=parseFloat(tr.querySelector(".q-qty").value||"0");
    const p=parseFloat(tr.querySelector(".q-price").value||"0");
    const sub=q*p; st+=sub; tr.querySelector(".q-sub").textContent=money(sub);
  });
  const iv = $("#q-ivu").value==="si" ? st*0.115 : 0;
  $("#q-st").textContent=money(st); $("#q-ivu-v").textContent=money(iv); $("#q-total").textContent=money(st+iv);
  return {st,iv,total:st+iv};
}
function qFromForm(){
  const items = Array.from($$("#q-items tbody tr")).map(tr=>({
    desc: tr.querySelector(".q-desc").value, qty: parseFloat(tr.querySelector(".q-qty").value||"0"), price: parseFloat(tr.querySelector(".q-price").value||"0")
  }));
  const t=qRecalc();
  return {id:Date.now(), fecha:new Date().toISOString(), cliente:$("#q-cliente").value.trim(), desc:$("#q-desc").value.trim(), items, subtotal:t.st, ivu:t.iv, total:t.total, aprobada: Math.random()>0.35};
}
function qRenderHist(){
  $("#q-hist").innerHTML = quotes.slice().reverse().map(q=>'<div class="item"><div><b>'+q.cliente+'</b> ‚Äî '+q.desc+'<br><span class="muted">'+new Date(q.fecha).toLocaleDateString()+'</span></div><div>'+money(q.total)+'</div></div>').join("") || '<div class="item"><span class="muted">Vac√≠o</span></div>';
}
$("#q-add").onclick = ()=> qRow();
$("#q-ivu").onchange = qRecalc;
$("#q-save").onclick = ()=>{ if(!$("#q-cliente").value.trim()){ alert("Cliente requerido"); return; } if($$("#q-items tbody tr").length===0) qRow(); const q=qFromForm(); quotes.push(q); LS.set("oasisQuotesV3", quotes); qRenderHist(); alert("Guardado"); };
$("#q-export").onclick = ()=>{ const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([JSON.stringify(quotes,null,2)],{type:"application/json"})); a.download="oasis_cotizaciones.json"; a.click(); };
$("#q-print").onclick = ()=>{ const q=qFromForm(); printDoc('Cotizaci√≥n', q); };
qRow("Servicio/Equipo",1,0); qRenderHist();

/* ===== Factura ===== */
function fRow(desc="", qty=1, price=0){
  const tr=document.createElement("tr");
  tr.innerHTML='<td><input class="input f-desc" value="'+desc.replace(/"/g,'&quot;')+'"></td>' +
               '<td><input class="input f-qty" type="number" min="0" step="1" value="'+qty+'"></td>' +
               '<td><input class="input f-price" type="number" step="0.01" value="'+price+'"></td>' +
               '<td class="t-right f-sub">$0</td>' +
               '<td><button class="btn secondary f-del">‚úï</button></td>';
  tr.querySelectorAll("input").forEach(i=>i.addEventListener("input", fRecalc));
  tr.querySelector(".f-del").onclick=()=>{ tr.remove(); fRecalc(); };
  $("#f-items tbody").appendChild(tr); fRecalc();
}
function fRecalc(){
  let st=0;
  $$("#f-items tbody tr").forEach(tr=>{
    const q=parseFloat(tr.querySelector(".f-qty").value||"0");
    const p=parseFloat(tr.querySelector(".f-price").value||"0");
    const sub=q*p; st+=sub; tr.querySelector(".f-sub").textContent=money(sub);
  });
  const iv = st*0.115; $("#f-st").textContent=money(st); $("#f-ivu").textContent=money(iv); $("#f-total").textContent=money(st+iv);
  return {st,iv,total:st+iv};
}
$("#f-add").onclick = ()=> fRow();
$("#f-print").onclick = ()=>{
  const items = Array.from($$("#f-items tbody tr")).map(tr=>({desc: tr.querySelector(".f-desc").value, qty: parseFloat(tr.querySelector(".f-qty").value||"0"), price: parseFloat(tr.querySelector(".f-price").value||"0")}));
  const t=fRecalc();
  const data={fecha:new Date().toISOString(), cliente:$("#f-cliente").value.trim(), numero:$("#f-num").value.trim(), items, subtotal:t.st, ivu:t.iv, total:t.total};
  printDoc('Factura', data);
};
fRow("Servicio",1,0);

/* ===== Print helper (PDF) ===== */
function printDoc(title, data){
  var rows = (data.items||[]).map(function(it){
    return '<tr><td>'+it.desc+'</td><td>'+it.qty+'</td><td>'+money(it.price)+'</td><td class="t-right">'+money(it.qty*it.price)+'</td></tr>';
  }).join('');
  var PRINT_SCRIPT = '<script>window.print()<\\/script>'; // escaped
  var header = '<h1>Oasis Air Cleaner Services LLC</h1><div>787-664-3079 ¬∑ oasisservicespr.com</div>';
  var body =
    '<h2 style="margin-top:16px">'+title+'</h2>' +
    (data.numero ? '<div>No. '+data.numero+'</div>' : '') +
    (data.cliente ? '<div>Cliente: <b>'+data.cliente+'</b></div>' : '') +
    '<div class="muted">'+ new Date(data.fecha).toLocaleString() +'</div>' +
    (data.desc ? '<div style="margin-top:8px">'+data.desc+'</div>' : '') +
    '<table><thead><tr><th>√çtem</th><th>Cant.</th><th>Precio</th><th class="t-right">Subtotal</th></tr></thead><tbody>'+rows+'</tbody></table>' +
    '<div style="display:flex;gap:18px;justify-content:flex-end;margin-top:12px">' +
      '<div>Subtotal: <b>'+money(data.subtotal)+'</b></div>' +
      '<div>IVU: <b>'+money(data.ivu)+'</b></div>' +
      '<div>Total: <b>'+money(data.total)+'</b></div>' +
    '</div>';
  var html = '<html><head><meta charset="utf-8"><title>'+title+'</title>'+
    '<style>body{font-family:Arial, sans-serif; color:#111; padding:24px} h1{margin:0 0 6px 0} .muted{color:#666} table{width:100%;border-collapse:collapse;margin-top:12px} th,td{border-bottom:1px solid #ddd;padding:8px;text-align:left}.t-right{text-align:right}</style></head><body>'+
    header + body + PRINT_SCRIPT + '</body></html>';
  var w=window.open('about:blank'); w.document.write(html); w.document.close();
}

/* ===== Rendimiento ===== */
function renderRend(){
  const now=new Date(); const mes=now.getMonth(), ano=now.getFullYear();
  const ingresos = quotes.filter(q=>{ const d=new Date(q.fecha); return d.getMonth()===mes && d.getFullYear()===ano && q.aprobada; }).reduce((a,q)=>a+q.total,0);
  $("#r-ingresos").textContent=money(ingresos);
  const cerrados = citas.filter(c=> new Date(c.fecha)>= new Date(Date.now()-30*864e5)).length;
  $("#r-tickets").textContent=cerrados;
  const ser=Array.from({length:12}).map((_,i)=>{ const d=new Date(); d.setMonth(d.getMonth()-(11-i)); return quotes.filter(q=>{ const dq=new Date(q.fecha); return dq.getMonth()===d.getMonth() && dq.getFullYear()===d.getFullYear() && q.aprobada; }).reduce((a,q)=>a+q.total,0); });
  drawLine($("#r-chart"), ser);
}
function drawLine(canvas, series){
  const ctx=canvas.getContext("2d"), W=canvas.width, H=canvas.height, pad=12;
  ctx.clearRect(0,0,W,H);
  const max=Math.max.apply(null, series.concat([1])), min=Math.min.apply(null, series.concat([0]));
  ctx.lineWidth=2; ctx.strokeStyle="#39a8ff";
  const g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,"rgba(0,194,255,.22)"); g.addColorStop(1,"rgba(0,194,255,0)"); ctx.fillStyle=g;
  ctx.beginPath();
  series.forEach(function(v,i){ const x=pad+i*((W-2*pad)/(series.length-1)); const y=H-pad-((v-min)/(max-min||1))*(H-2*pad); if(i===0)ctx.moveTo(x,y); else ctx.lineTo(x,y); });
  ctx.stroke(); ctx.lineTo(W-pad,H-pad); ctx.lineTo(pad,H-pad); ctx.closePath(); ctx.fill();
}
renderRend(); updateDBCount();
</script>
</body>
</html>

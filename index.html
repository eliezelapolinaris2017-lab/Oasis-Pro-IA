<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OASIS PRO IA ‚Äî Dashboard (Home tiles + PDF iOS)</title>
<style>
  :root{--bg:#0b1624; --panel:#122033; --panel-2:#0f1b2b; --text:#e9eef8; --primary:#3aa0ff; --primary-2:#00c2ff; --shadow:0 10px 24px rgba(0,0,0,.35)}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:radial-gradient(1200px 700px at -200px -100px, rgba(10,70,120,.25), transparent 70%),var(--bg);color:var(--text)}
  .topbar{position:sticky;top:0;z-index:5;display:flex;gap:12px;align-items:center;padding:16px;background:linear-gradient(180deg, rgba(7,15,25,.8), rgba(7,15,25,.4));border-bottom:1px solid rgba(255,255,255,.06)}
  .logo{width:40px;height:40px;border-radius:12px;background:conic-gradient(from 60deg,#00c2ff,#1986ff,#00c2ff)}
  .brand{font-weight:800} .brand small{display:block;opacity:.8}
  .btn{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(90deg,var(--primary),var(--primary-2));border:none;color:#00122a;font-weight:800;padding:10px 14px;border-radius:12px;cursor:pointer;box-shadow:0 8px 18px rgba(0,162,255,.35)}
  .btn.secondary{background:#0f1c2d;color:#d8e6ff;border:1px solid rgba(255,255,255,.08);box-shadow:none}
  .layout{display:grid;grid-template-columns:280px 1fr;min-height:calc(100vh - 72px)}
  .menu{border-right:1px solid rgba(255,255,255,.06);background:linear-gradient(180deg,var(--panel-2),#0c1a2a 60%, #0a1626);padding:18px}
  .menu ul{list-style:none;margin:0;padding:0;display:grid;gap:8px}
  .menu li a{display:flex;gap:12px;align-items:center;padding:12px;border-radius:12px;color:#c5d2ea}
  .menu li a:hover{background:rgba(255,255,255,.07);color:#fff}
  .content{padding:24px;display:grid;gap:22px}
  .card{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:18px;box-shadow:var(--shadow)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .input,select,textarea{width:100%;padding:12px 14px;border-radius:12px;background:#0e1c2e;border:1px solid rgba(255,255,255,.08);color:var(--text)}
  .list{display:grid;gap:10px;max-height:260px;overflow:auto}
  .item{background:#0f1c2d;border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:10px 12px;display:flex;justify-content:space-between;align-items:center;gap:8px}
  .t-right{text-align:right} .hidden{display:none!important}
  @media(max-width:1100px){.layout{grid-template-columns:1fr}.menu{display:none}.row,.grid{grid-template-columns:1fr}}
  .mini{display:flex;gap:6px}
  /* Home tiles */
  .tiles{display:grid;gap:14px}
  .tile{display:flex;align-items:center;gap:12px;background:#0f1c2d;border:1px solid rgba(255,255,255,.06);padding:16px;border-radius:18px}
  .tile:hover{background:#12243a}
  .tile span{font-weight:600}
</style>
</head>
<body>
<header class="topbar">
  <div class="logo"></div><div class="brand">OASIS <small>PRO IA</small></div><div style="flex:1"></div>
  <button class="btn secondary" id="btnShowMenu">‚ò∞ Men√∫</button>
</header>

<div class="layout">
  <aside class="menu" id="leftMenu">
    <ul>
      <li><a href="#" data-target="home">üè† Inicio</a></li>
      <li><a href="#" data-target="diagnostico">üß∞ Diagn√≥stico</a></li>
      <li><a href="#" data-target="agenda">üóìÔ∏è Agenda</a></li>
      <li><a href="#" data-target="cotizaciones">üíº Cotizaciones</a></li>
      <li><a href="#" data-target="factura">üßæ Factura</a></li>
      <li><a href="#" data-target="rendimiento">üìà Rendimiento</a></li>
      <li><a href="#" data-target="config">‚öôÔ∏è Configuraci√≥n</a></li>
    </ul>
  </aside>

  <main class="content">
    <!-- HOME: SOLO para entrada -->
    <section id="home" class="section">
      <div class="card" style="padding:24px">
        <h2 style="margin-top:2px">¬øQu√© deseas hacer?</h2>
        <div class="tiles" id="homeTiles">
          <a class="tile" href="#" data-goto="diagnostico">üß∞ <span>Diagn√≥stico</span></a>
          <a class="tile" href="#" data-goto="agenda">üóìÔ∏è <span>Agenda</span></a>
          <a class="tile" href="#" data-goto="cotizaciones">üíº <span>Cotizaciones</span></a>
          <a class="tile" href="#" data-goto="factura">üßæ <span>Factura</span></a>
          <a class="tile" href="#" data-goto="rendimiento">üìà <span>Rendimiento</span></a>
          <a class="tile" href="#" data-goto="config">‚öôÔ∏è <span>Configuraci√≥n</span></a>
        </div>
      </div>
    </section>

    <section id="diagnostico" class="section hidden">
      <div class="card">
        <h3>Buscar</h3>
        <div class="row">
          <input id="dg-marca" class="input" placeholder="Marca">
          <input id="dg-q" class="input" placeholder="C√≥digo o s√≠ntoma">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="dg-buscar">Diagnosticar</button>
          <button class="btn secondary" id="dg-limpiar" style="margin-left:auto">Limpiar</button>
        </div>
        <div id="dg-res" class="list" style="margin-top:10px"></div>
      </div>
      <div class="card"><small>Para a√±adir/editar c√≥digos ve a <b>Configuraci√≥n ‚Üí C√≥digos</b>.</small></div>
    </section>

    <section id="agenda" class="section hidden">
      <div class="card">
        <h3>Nueva cita</h3>
        <div class="row">
          <input id="c-fecha" type="date" class="input">
          <input id="c-hora" type="time" class="input" value="09:00">
          <input id="c-hora-fin" type="time" class="input" value="10:00">
        </div>
        <div class="row">
          <input id="c-cliente" class="input" placeholder="Cliente">
          <input id="c-serv" class="input" placeholder="Servicio">
        </div>
        <input id="c-notas" class="input" placeholder="Notas">
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="c-guardar">Guardar</button>
          <a class="btn secondary" id="c-url" target="_blank">Google Calendar (URL)</a>
        </div>
      </div>
      <div class="card"><h3>Citas</h3><div id="citas-list" class="list"></div></div>
    </section>

    <section id="cotizaciones" class="section hidden">
      <div class="card">
        <h3>Cotizaci√≥n</h3>
        <div class="row"><input id="q-cliente" class="input" placeholder="Cliente"><select id="q-ivu" class="input"><option value="si">IVU 11.5% S√≠</option><option value="no">IVU No</option></select></div>
        <input id="q-desc" class="input" placeholder="Descripci√≥n general">
        <table id="q-items" style="margin-top:10px"><thead><tr><th>√çtem</th><th style="width:100px">Cant.</th><th style="width:140px">Precio</th><th class="t-right" style="width:140px">Subtotal</th><th style="width:60px"></th></tr></thead><tbody></tbody></table>
        <div style="display:flex;gap:16px;justify-content:flex-end;margin-top:10px">
          <div>Subtotal: <b id="q-st">$0</b></div><div>IVU: <b id="q-ivu-v">$0</b></div><div>Total: <b id="q-total">$0</b></div>
        </div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn" id="q-add">A√±adir √≠tem</button><button class="btn" id="q-save">Guardar</button>
          <button class="btn secondary" id="q-print">Ver PDF</button><button class="btn secondary" id="q-export">Exportar JSON</button>
        </div>
      </div>
      <div class="card"><h3>Historial de cotizaciones</h3><div id="q-hist" class="list"></div></div>
    </section>

    <section id="factura" class="section hidden">
      <div class="card">
        <h3>Factura</h3>
        <div class="row"><input id="f-cliente" class="input" placeholder="Cliente"><input id="f-num" class="input" placeholder="No. Factura"></div>
        <table id="f-items" style="margin-top:10px"><thead><tr><th>√çtem</th><th style="width:100px">Cant.</th><th style="width:140px">Precio</th><th class="t-right" style="width:140px">Subtotal</th><th style="width:60px"></th></tr></thead><tbody></tbody></table>
        <div style="display:flex;gap:16px;justify-content:flex-end;margin-top:10px">
          <div>Subtotal: <b id="f-st">$0</b></div><div>IVU: <b id="f-ivu">$0</b></div><div>Total: <b id="f-total">$0</b></div>
        </div>
        <div style="display:flex;gap:8px;margin-top:10px"><button class="btn" id="f-add">A√±adir √≠tem</button><button class="btn" id="f-save">Guardar</button><button class="btn secondary" id="f-print">Ver PDF</button></div>
      </div>
      <div class="card"><h3>Historial de facturas</h3><div id="f-hist" class="list"></div></div>
    </section>

    <section id="rendimiento" class="section hidden">
      <div class="card"><h3>Indicadores</h3>
        <div class="grid"><div class="card" style="background:#0e1b2b">Tickets (30d)<br><b id="r-tickets">0</b></div><div class="card" style="background:#0e1b2b">Ingresos Mes<br><b id="r-ingresos">$0</b></div></div>
        <canvas id="r-chart" width="700" height="160"></canvas>
      </div>
    </section>

    <section id="config" class="section hidden">
      <div class="grid">
        <div class="card">
          <h3>C√≥digos ‚Äî A√±adir/Editar</h3>
          <div class="row"><input id="db-marca" class="input" placeholder="Marca"><input id="db-codigo" class="input" placeholder="C√≥digo"></div>
          <input id="db-nombre" class="input" placeholder="Nombre / Causa">
          <input id="db-sint" class="input" placeholder="S√≠ntomas (separados por coma)">
          <textarea id="db-pasos" class="input" rows="4" placeholder="Pasos (uno por l√≠nea)"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" id="db-guardar">Guardar/Actualizar</button><button class="btn secondary" id="db-borrar">Eliminar</button>
            <button class="btn secondary" id="db-export">Exportar JSON</button>
            <label class="btn secondary"><input type="file" id="db-import" accept="application/json" style="display:none"> Importar JSON</label>
          </div>
          <div id="db-list" class="list" style="margin-top:10px"></div>
        </div>
        <div class="card">
          <h3>Clientes</h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <label class="btn secondary"><input type="file" id="cli-csv" accept=".csv,text/csv" style="display:none"> Importar CSV</label>
            <button class="btn secondary" id="cli-export">Exportar JSON</button>
            <button class="btn" id="cli-add">A√±adir cliente</button>
          </div>
          <div id="cli-form" class="row hidden" style="margin-top:8px">
            <input id="cli-nombre" class="input" placeholder="Nombre">
            <input id="cli-tel" class="input" placeholder="Tel√©fono">
            <input id="cli-email" class="input" placeholder="Email">
            <input id="cli-dir" class="input" placeholder="Direcci√≥n">
            <button class="btn" id="cli-save">Guardar</button>
          </div>
          <div id="cli-list" class="list" style="margin-top:10px"></div>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
const $ = s=>document.querySelector(s), $$ = s=>document.querySelectorAll(s);
const LS = { get:k=>JSON.parse(localStorage.getItem(k)||'null'), set:(k,v)=>localStorage.setItem(k, JSON.stringify(v)) };
const money = n => new Intl.NumberFormat('es-PR',{style:'currency',currency:'USD'}).format(n||0);

$("#btnShowMenu").onclick=()=>{ const el=$("#leftMenu"); el.style.display=getComputedStyle(el).display==="none"?"block":"none"; };
function route(id){ $$(".section").forEach(s=>s.classList.add("hidden")); $("#"+id).classList.remove("hidden"); if(innerWidth<=1100) $("#leftMenu").style.display="none"; }
$("#leftMenu").addEventListener("click",e=>{ const a=e.target.closest("a[data-target]"); if(!a)return; e.preventDefault(); route(a.dataset.target); });
$("#homeTiles").addEventListener("click",e=>{ const a=e.target.closest("a[data-goto]"); if(!a)return; e.preventDefault(); route(a.dataset.goto); });

// Datos
let DB = LS.get("oasisDB") || [{marca:"TGM",codigo:"E1",nombre:"Error de comunicaci√≥n",sintomas:["no enciende U.E.","parpadeo tablero"],pasos:["Verificar cable entre U.I. y U.E.","Revisar S1/S2/S3","Reseteo 5 min","Posible placa exterior"]},{marca:"Midea",codigo:"F0",nombre:"Refrigerante bajo / Fuga",sintomas:["no enfr√≠a","hielo en tuber√≠a"],pasos:["Prueba de fuga 400 psi","Vac√≠o < 500 micrones","Carga por peso"]}];
let citas = LS.get("oasisCitas") || [];
let quotes = LS.get("oasisQuotesV3") || [];
let invoices = LS.get("oasisInvoicesV1") || [];
let clientes = LS.get("oasisClientes") || [];

/* Util ‚Äî iOS open new tab with data: URL */
function openHTMLInNewTab(html){
  const a=document.createElement("a");
  a.href = "data:text/html;charset=utf-8," + encodeURIComponent(html);
  a.target="_blank"; a.rel="noopener";
  document.body.appendChild(a); a.click(); a.remove();
}

/* Diagn√≥stico */
function buscarDiag(q,marca){ q=(q||'').toLowerCase().trim(); return DB.filter(r=>(!marca||r.marca.toLowerCase()===marca.toLowerCase()) && (r.codigo.toLowerCase()===q || r.nombre.toLowerCase().includes(q) || r.sintomas.some(s=>s.toLowerCase().includes(q)))); }
function renderDiagList(list,t){ t.innerHTML=list.length? list.map(r=>'<div class="item" style="align-items:flex-start"><div><b>['+r.marca+'] '+r.codigo+'</b> ‚Äî '+r.nombre+'<br><small>'+r.sintomas.join(" ¬∑ ")+'</small><ol style="margin:6px 0 0 18px">'+r.pasos.map(p=>'<li>'+p+'</li>').join("")+'</ol></div></div>').join("") : '<div class="item"><span class="muted">Sin resultados</span></div>'; }
$("#dg-buscar").onclick=()=> renderDiagList(buscarDiag($("#dg-q").value,$("#dg-marca").value), $("#dg-res"));
$("#dg-limpiar").onclick=()=>{ $("#dg-q").value=''; $("#dg-res").innerHTML=''; };

/* Config ‚Üí C√≥digos */
function loadDB(i){ const r=DB[i]; $("#db-marca").value=r.marca; $("#db-codigo").value=r.codigo; $("#db-nombre").value=r.nombre; $("#db-sint").value=r.sintomas.join(", "); $("#db-pasos").value=r.pasos.join("\n"); }
function saveDB(){ LS.set("oasisDB",DB); renderDB(); }
function renderDB(){ $("#db-list").innerHTML=DB.map((r,i)=>'<div class="item"><div><b>['+r.marca+'] '+r.codigo+'</b> ‚Äî '+r.nombre+'</div><button class="btn secondary" onclick="loadDB('+i+')">Editar</button></div>').join(""); }
$("#db-guardar").onclick=()=>{ const rec={marca:$("#db-marca").value.trim(),codigo:$("#db-codigo").value.trim(),nombre:$("#db-nombre").value.trim(),sintomas:$("#db-sint").value.split(",").map(s=>s.trim()).filter(Boolean),pasos:$("#db-pasos").value.split("\\n").map(s=>s.trim()).filter(Boolean)}; if(!rec.marca||!rec.codigo){alert("Marca y C√≥digo requeridos");return;} const ix=DB.findIndex(x=>x.marca.toLowerCase()===rec.marca.toLowerCase()&&x.codigo.toLowerCase()===rec.codigo.toLowerCase()); if(ix>=0)DB[ix]=rec; else DB.push(rec); saveDB(); alert("Guardado"); };
$("#db-borrar").onclick=()=>{ const marca=$("#db-marca").value.trim(), codigo=$("#db-codigo").value.trim(); const len=DB.length; DB=DB.filter(x=>!(x.marca.toLowerCase()===marca.toLowerCase()&&x.codigo.toLowerCase()===codigo.toLowerCase())); if(DB.length<len){saveDB();alert("Eliminado");} else alert("No encontrado"); };
$("#db-export").onclick=()=>{ const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([JSON.stringify(DB,null,2)],{type:"application/json"})); a.download="oasis_codigos_error.json"; a.click(); };
$("#db-import").addEventListener("change",e=>{ const f=e.target.files[0]; if(!f)return; const fr=new FileReader(); fr.onload=()=>{ try{ DB=JSON.parse(fr.result); saveDB(); alert("Importado"); }catch(_){ alert("JSON inv√°lido"); } }; fr.readAsText(f); });
renderDB();

/* Config ‚Üí Clientes */
function renderClientes(){ $("#cli-list").innerHTML=clientes.length? clientes.map((c,i)=>'<div class="item"><div><b>'+c.nombre+'</b> ¬∑ '+(c.telefono||'')+' ¬∑ <small>'+(c.email||'')+'</small><br><small>'+(c.direccion||'')+'</small></div><div class="mini"><button class="btn secondary" onclick="delCliente('+i+')">Borrar</button></div></div>').join("") : '<div class="item"><small>Sin clientes</small></div>'; }
function delCliente(i){ clientes.splice(i,1); LS.set("oasisClientes",clientes); renderClientes(); }
$("#cli-add").onclick=()=> $("#cli-form").classList.toggle("hidden");
$("#cli-save").onclick=()=>{ const c={nombre:$("#cli-nombre").value.trim(),telefono:$("#cli-tel").value.trim(),email:$("#cli-email").value.trim(),direccion:$("#cli-dir").value.trim()}; if(!c.nombre){alert("Nombre requerido");return;} clientes.push(c); LS.set("oasisClientes",clientes); $("#cli-form").classList.add("hidden"); $("#cli-nombre").value=$("#cli-tel").value=$("#cli-email").value=$("#cli-dir").value=""; renderClientes(); };
$("#cli-export").onclick=()=>{ const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([JSON.stringify(clientes,null,2)],{type:"application/json"})); a.download="oasis_clientes.json"; a.click(); };
$("#cli-csv").addEventListener("change",e=>{ const f=e.target.files[0]; if(!f)return; const fr=new FileReader(); fr.onload=()=>{ try{ const lines=fr.result.split(/\\r?\\n/).filter(Boolean); const headers=lines.shift().split(",").map(h=>h.trim().toLowerCase()); lines.forEach(line=>{ const cols=line.split(","); const obj={}; headers.forEach((h,idx)=>obj[h]=cols[idx]?cols[idx].trim():""); if(obj.nombre) clientes.push({nombre:obj.nombre,telefono:obj.telefono||obj.tel||"",email:obj.email||"",direccion:obj.direccion||obj.dir||""}); }); LS.set("oasisClientes",clientes); renderClientes(); alert("Clientes importados: '+lines.length+'"); }catch(_){ alert("CSV inv√°lido"); } }; fr.readAsText(f); });
renderClientes();

/* Agenda */
function gcURL(c){ const start=(c.fecha+'T'+c.hora+':00').replace(/[-:]/g,''); const end=(c.fecha+'T'+(c.hora_fin||c.hora)+':00').replace(/[-:]/g,''); const text=encodeURIComponent(c.servicio+' ‚Äî '+c.cliente); const details=encodeURIComponent(c.notas||''); return 'https://calendar.google.com/calendar/u/0/r/eventedit?text='+text+'&dates='+start+'/'+end+'&details='+details; }
function renderCitas(){ $("#citas-list").innerHTML=citas.slice().reverse().map(c=>'<div class="item"><div><b>'+c.fecha+' '+c.hora+'</b> ¬∑ '+c.cliente+' ‚Äî <small>'+c.servicio+'</small></div><div class="mini"><a class="btn secondary" target="_blank" href="'+gcURL(c)+'">GCal</a><button class="btn secondary" onclick="delCita('+c.id+')">Borrar</button></div></div>').join("") || '<div class="item"><small>Sin citas</small></div>'; }
function delCita(id){ citas=citas.filter(c=>c.id!==id); LS.set("oasisCitas",citas); renderCitas(); }
$("#c-fecha").value=new Date().toISOString().slice(0,10);
$("#c-guardar").onclick=()=>{ const c={id:Date.now(),fecha:$("#c-fecha").value,hora:$("#c-hora").value,hora_fin:$("#c-hora-fin").value,cliente:$("#c-cliente").value,servicio:$("#c-serv").value,notas:$("#c-notas").value}; citas.push(c); LS.set("oasisCitas",citas); $("#c-url").href=gcURL(c); renderCitas(); alert("Cita guardada"); };
$("#c-url").href="about:blank";

/* Cotizaci√≥n */
function qRow(desc="",qty=1,price=0){ const tr=document.createElement("tr"); tr.innerHTML='<td><input class="input q-desc" value="'+desc.replace(/"/g,'&quot;')+'"></td><td><input class="input q-qty" type="number" min="0" step="1" value="'+qty+'"></td><td><input class="input q-price" type="number" step="0.01" value="'+price+'"></td><td class="t-right q-sub">$0</td><td><button class="btn secondary q-del">‚úï</button></td>'; tr.querySelectorAll("input").forEach(i=>i.addEventListener("input",qRecalc)); tr.querySelector(".q-del").onclick=()=>{ tr.remove(); qRecalc(); }; $("#q-items tbody").appendChild(tr); qRecalc(); }
function qRecalc(){ let st=0; $$("#q-items tbody tr").forEach(tr=>{ const q=parseFloat(tr.querySelector(".q-qty").value||"0"); const p=parseFloat(tr.querySelector(".q-price").value||"0"); const sub=q*p; st+=sub; tr.querySelector(".q-sub").textContent=money(sub); }); const iv=$("#q-ivu").value==="si"?st*0.115:0; $("#q-st").textContent=money(st); $("#q-ivu-v").textContent=money(iv); $("#q-total").textContent=money(st+iv); return {st,iv,total:st+iv}; }
function qFromForm(){ const items=Array.from($$("#q-items tbody tr")).map(tr=>({desc:tr.querySelector(".q-desc").value,qty:parseFloat(tr.querySelector(".q-qty").value||"0"),price:parseFloat(tr.querySelector(".q-price").value||"0")})); const t=qRecalc(); return {id:Date.now(),fecha:new Date().toISOString(),cliente:$("#q-cliente").value.trim(),desc:$("#q-desc").value.trim(),items,subtotal:t.st,ivu:t.iv,total:t.total,aprobada:Math.random()>0.35}; }
function qRenderHist(){ $("#q-hist").innerHTML = quotes.slice().reverse().map((q)=>'<div class="item"><div><b>'+q.cliente+'</b> ‚Äî '+q.desc+'<br><small>'+new Date(q.fecha).toLocaleDateString()+'</small></div><div class="mini"><button class="btn secondary btn-ver" data-doc="'+encodeURIComponent(JSON.stringify({t:'Cotizaci√≥n',d:q}))+'">Ver PDF</button><button class="btn secondary" onclick="delQuote('+q.id+')">Borrar</button></div></div>').join("") || '<div class="item"><small>Vac√≠o</small></div>'; }
function delQuote(id){ quotes = quotes.filter(q=>q.id!==id); LS.set("oasisQuotesV3",quotes); qRenderHist(); }
$("#q-add").onclick=()=>qRow(); $("#q-ivu").onchange=qRecalc; $("#q-save").onclick=()=>{ if(!$("#q-cliente").value.trim()){alert("Cliente requerido");return;} if($$("#q-items tbody tr").length===0)qRow(); const q=qFromForm(); quotes.push(q); LS.set("oasisQuotesV3",quotes); qRenderHist(); alert("Guardado"); };
$("#q-export").onclick=()=>{ const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([JSON.stringify(quotes,null,2)],{type:"application/json"})); a.download="oasis_cotizaciones.json"; a.click(); };
$("#q-print").onclick=()=>{ const q=qFromForm(); printDoc('Cotizaci√≥n', q); };
qRow("Servicio/Equipo",1,0); qRenderHist();

/* Factura */
function fRow(desc="",qty=1,price=0){ const tr=document.createElement("tr"); tr.innerHTML='<td><input class="input f-desc" value="'+desc.replace(/"/g,'&quot;')+'"></td><td><input class="input f-qty" type="number" min="0" step="1" value="'+qty+'"></td><td><input class="input f-price" type="number" step="0.01" value="'+price+'"></td><td class="t-right f-sub">$0</td><td><button class="btn secondary f-del">‚úï</button></td>'; tr.querySelectorAll("input").forEach(i=>i.addEventListener("input",fRecalc)); tr.querySelector(".f-del").onclick=()=>{ tr.remove(); fRecalc(); }; $("#f-items tbody").appendChild(tr); fRecalc(); }
function fRecalc(){ let st=0; $$("#f-items tbody tr").forEach(tr=>{ const q=parseFloat(tr.querySelector(".f-qty").value||"0"); const p=parseFloat(tr.querySelector(".f-price").value||"0"); const sub=q*p; st+=sub; tr.querySelector(".f-sub").textContent=money(sub); }); const iv=st*0.115; $("#f-st").textContent=money(st); $("#f-ivu").textContent=money(iv); $("#f-total").textContent=money(st+iv); return {st,iv,total:st+iv}; }
function fFromForm(){ const items=Array.from($$("#f-items tbody tr")).map(tr=>({desc:tr.querySelector(".f-desc").value,qty:parseFloat(tr.querySelector(".f-qty").value||"0"),price:parseFloat(tr.querySelector(".f-price").value||"0")})); const t=fRecalc(); return {id:Date.now(),fecha:new Date().toISOString(),cliente:$("#f-cliente").value.trim(),numero:$("#f-num").value.trim(),items,subtotal:t.st,ivu:t.iv,total:t.total}; }
function fRenderHist(){ $("#f-hist").innerHTML = invoices.slice().reverse().map(inv=>'<div class="item"><div><b>'+inv.cliente+'</b> ‚Äî #'+(inv.numero||'‚Äî')+'<br><small>'+new Date(inv.fecha).toLocaleDateString()+'</small></div><div class="mini"><button class="btn secondary btn-ver" data-doc="'+encodeURIComponent(JSON.stringify({t:'Factura',d:inv}))+'">Ver PDF</button><button class="btn secondary" onclick="delInvoice('+inv.id+')">Borrar</button></div></div>').join("") || '<div class="item"><small>Vac√≠o</small></div>'; }
function delInvoice(id){ invoices=invoices.filter(i=>i.id!==id); LS.set("oasisInvoicesV1",invoices); fRenderHist(); }
$("#f-add").onclick=()=>fRow();
$("#f-save").onclick=()=>{ const data=fFromForm(); invoices.push(data); LS.set("oasisInvoicesV1",invoices); fRenderHist(); alert("Guardado"); };
$("#f-print").onclick=()=>{ const data=fFromForm(); invoices.push(data); LS.set("oasisInvoicesV1",invoices); fRenderHist(); printDoc('Factura',data); };
fRow("Servicio",1,0); fRenderHist();

/* Print/Preview para iOS */
function printDoc(title,data){
  const rows=(data.items||[]).map(it=>'<tr><td>'+it.desc+'</td><td>'+it.qty+'</td><td>'+money(it.price)+'</td><td class="t-right">'+money(it.qty*it.price)+'</td></tr>').join('');
  const html='<html><head><meta charset="utf-8"><title>'+title+'</title><style>body{font-family:Arial,sans-serif;color:#111;padding:24px}h1{margin:0 0 6px 0}.muted{color:#666}table{width:100%;border-collapse:collapse;margin-top:12px}th,td{border-bottom:1px solid #ddd;padding:8px;text-align:left}.t-right{text-align:right} .brand{display:flex;gap:10px;align-items:center} .tag{font-size:12px;color:#666}</style></head><body>' +
    '<div class="brand"><h1>Oasis Air Cleaner Services LLC</h1></div><div class="tag">787-664-3079 ¬∑ oasisservicespr.com ¬∑ Pagos: ATH M√≥vil, cheque, cash, transferencia, tarjeta</div>' +
    '<h2 style="margin-top:16px">'+title+'</h2>' +
    (data.numero? '<div>No. '+data.numero+'</div>':'') +
    (data.cliente? '<div>Cliente: <b>'+data.cliente+'</b></div>':'') +
    '<div class="muted">'+ new Date(data.fecha).toLocaleString() +'</div>' +
    (data.desc? '<div style="margin-top:8px">'+data.desc+'</div>':'') +
    '<table><thead><tr><th>√çtem</th><th>Cant.</th><th>Precio</th><th class="t-right">Subtotal</th></tr></thead><tbody>'+rows+'</tbody></table>' +
    '<div style="display:flex;gap:18px;justify-content:flex-end;margin-top:12px"><div>Subtotal: <b>'+money(data.subtotal)+'</b></div><div>IVU: <b>'+money(data.ivu)+'</b></div><div>Total: <b>'+money(data.total)+'</b></div></div>' +
    '<script>setTimeout(()=>{try{window.print()}catch(e){}},300)<\\/script>' +
    '</body></html>';
  openHTMLInNewTab(html);
}

/* Delegaci√≥n "Ver PDF" */
document.addEventListener("click",(e)=>{
  const btn=e.target.closest(".btn-ver");
  if(!btn) return;
  const payload = JSON.parse(decodeURIComponent(btn.dataset.doc));
  printDoc(payload.t, payload.d);
});

/* Rendimiento */
function renderRend(){ const now=new Date(); const mes=now.getMonth(), ano=now.getFullYear(); const ingresos=quotes.filter(q=>{const d=new Date(q.fecha); return d.getMonth()===mes && d.getFullYear()===ano && q.aprobada;}).reduce((a,q)=>a+q.total,0); $("#r-ingresos").textContent=money(ingresos); const cerrados=citas.filter(c=> new Date(c.fecha)>= new Date(Date.now()-30*864e5)).length; $("#r-tickets").textContent=cerrados; const series=Array.from({length:12}).map((_,i)=>{ const d=new Date(); d.setMonth(d.getMonth()-(11-i)); return quotes.filter(q=>{ const dq=new Date(q.fecha); return dq.getMonth()===d.getMonth() && dq.getFullYear()===d.getFullYear() && q.aprobada; }).reduce((a,q)=>a+q.total,0); }); drawLine($("#r-chart"),series); }
function drawLine(canvas,series){ const ctx=canvas.getContext("2d"),W=canvas.width,H=canvas.height,pad=12; ctx.clearRect(0,0,W,H); const max=Math.max.apply(null,series.concat([1])),min=Math.min.apply(null,series.concat([0])); ctx.lineWidth=2; ctx.strokeStyle="#39a8ff"; const g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,"rgba(0,194,255,.22)"); g.addColorStop(1,"rgba(0,194,255,0)"); ctx.fillStyle=g; ctx.beginPath(); series.forEach(function(v,i){ const x=pad+i*((W-2*pad)/(series.length-1)); const y=H-pad-((v-min)/(max-min||1))*(H-2*pad); if(i===0)ctx.moveTo(x,y); else ctx.lineTo(x,y); }); ctx.stroke(); ctx.lineTo(W-pad,H-pad); ctx.lineTo(pad,H-pad); ctx.closePath(); ctx.fill(); }
renderRend();

// Ruta inicial: HOME con tiles
route('home');
</script>
</body>
</html>
